<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DRK ENERGÍA | Comparador Pro V4.55</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons CDN -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- SheetJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- jsqr para decodificación -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    
    <!-- Firebase Imports for Persistence -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, setLogLevel, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Expose Firebase objects globally for use in the main script block
        window.firebase = { 
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken,
            getFirestore, doc, setDoc, getDoc, setLogLevel, deleteDoc
        };
    </script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #ea580c; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-track { background-color: #e2e8f0; }
        .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }

        /* Estilos específicos para la zona de pegado del QR (Sepia/Marrón) */
        #pasteZone.qr-paste-zone {
            padding: 30px; 
            border: 3px dashed #a0522d; /* Sienna dashed border */
            border-radius: 10px; 
            text-align: center; 
            background: #fefdfb; /* Very light sepia background */
            cursor: pointer; 
            color: #8b4513; /* Saddle Brown text */
            transition: all 0.3s ease;
        }
        #pasteZone.qr-paste-zone.focused {
            border-color: #8b4513; /* Saddle Brown focus border */
            background: #f0e6da; /* Light Tan background */
            color: #5c3017; /* Dark Brown text */
        }
        #qr-preview {
            max-width: 250px; 
            display: none;
            border: 3px solid #8b4513; 
            border-radius: 8px;
            margin-top: 15px;
        }
        .qr-block {
            background: #f9f6f3; 
            padding: 15px; 
            border-radius: 8px;
            border: 1px solid #d4c5b7; 
            margin-top: 15px;
        }
        .qr-kv { 
            display: flex; 
            justify-content: space-between; 
            padding: 7px 0;
            border-bottom: 1px dashed #d4c5b7; 
            align-items: center;
        }
    </style>
    <script>
        const PDF_JS_CDN = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js";
        
        // CONSTANTES GLOBALES DE CÁLCULO
        const IVA_RATE = 0.21;
        const IMPUESTO_HC_RATE = 0.00234; // Constante para Gas

        // --- ESTADO Y CONFIGURACIÓN FIREBASE/LOCAL ---
        let db, auth, userId, appId;
        let isFirebaseReady = false; 
        
        let state = {
            config: { 
                tariff: '3.0TD', // Valor inicial cambiado a 3.0TD para consistencia con el ejemplo
                days: 31, 
                comparisonType: 'total', 
                inputMode: 'manual', 
                retailerFilter: '', 
                segmentFilter: '', 
                zoneFilter: '', // NUEVO: Filtro de Zona Geográfica
                winningTariffId: null, 
                isSinglePresentationMode: false, 
                reportHeader: 'DRK Energía | Asesoría Energética', 
                brand: 'POWER CUP', 
                rankingRetailerFilter: '', 
                winningRetailerFilter: '',
                isMultiCupsMode: false, 
                lastUploadDate: null 
            }, 
            inputs: { clientName: '', cups: '', commercialCode: '', p1_kw: 0, p2_kw: 0, p3_kw: 0, p4_kw: 0, p5_kw: 0, p6_kw: 0, p1_kwh: 0, p2_kwh: 0, p3_kwh: 0, p4_kwh: 0, p5_kwh: 0, p6_kwh: 0, clientTotalInvoice: 0 },
            currentPrices: { p1_pow: 0, p2_pow: 0, p3_pow: 0, p4_pow: 0, p5_pow: 0, p6_pow: 0, p1_en: 0, p2_en: 0, p3_en: 0, p4_en: 0, p5_en: 0, p6_en: 0 },
            uploadedTariffs: [], 
            comparisonResults: [], 
            result: null, 
            isScanning: false, 
            scanStatus: "Esperando...", 
            showReportModal: false, 
            retailerFilterOptions: [], 
            segmentFilterOptions: [], 
            zoneFilterOptions: [], // NUEVO: Opciones de Zona Geográfica
            selectedRankingIds: [],
            
            multiCupsData: [], 
            currentCupsIndex: 0, 
            currentStudyResult: null, 
            isFinalReportVisible: false, 
            
            showQRScannerModal: false, // NUEVO: Estado del modal QR
        };
        
        function resetAllState() {
            state.inputs = { clientName: '', cups: '', commercialCode: '', p1_kw: 0, p2_kw: 0, p3_kw: 0, p4_kw: 0, p5_kw: 0, p6_kw: 0, p1_kwh: 0, p2_kwh: 0, p3_kwh: 0, p4_kwh: 0, p5_kwh: 0, p6_kwh: 0, clientTotalInvoice: 0 };
            state.currentPrices = { p1_pow: 0, p2_pow: 0, p3_pow: 0, p4_pow: 0, p5_pow: 0, p6_pow: 0, p1_en: 0, p2_en: 0, p3_en: 0, p4_en: 0, p5_en: 0, p6_en: 0 };
            state.comparisonResults = [];
            state.result = null;
            state.selectedRankingIds = [];
            
            state.multiCupsData = [];
            state.currentCupsIndex = 0;
            state.currentStudyResult = null;
            state.isFinalReportVisible = false;

            state.config = { ...state.config, 
                segmentFilter: '', 
                zoneFilter: '', // NUEVO: Resetear filtro de zona
                winningTariffId: null,
                retailerFilter: '',
                rankingRetailerFilter: '',
                winningRetailerFilter: ''
            };
        }

        // --- FIREBASE AND LOCAL STORAGE FUNCTIONS ---
        async function loadTariffsFromStorage() {
            let loaded = false;
            
            if (db && userId && isFirebaseReady) {
                const { doc, getDoc } = window.firebase;
                try {
                    const docRef = doc(db, 'artifacts', appId, 'users', userId, 'tariff_database', 'current_tariffs');
                    const docSnap = await getDoc(docRef);

                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        const tariffs = data.tariffs || [];
                        const uploadDate = data.uploadDate ? new Date(data.uploadDate) : null;
                        
                        setState({
                            uploadedTariffs: tariffs,
                            config: { ...state.config, lastUploadDate: uploadDate },
                            retailerFilterOptions: [...new Set(tariffs.map(t=>t.retailer))],
                            segmentFilterOptions: [...new Set(tariffs.map(t=>t.segment))].sort(),
                            zoneFilterOptions: [...new Set(tariffs.map(t=>t.zone))].sort(), // NUEVO: Cargar opciones de zona
                        });
                        showNotification(`Tarifas cargadas de la Nube (${tariffs.length}).`, 'info');
                        loaded = true;
                    } 
                } catch (e) {
                    console.error("Error al cargar tarifas de Firestore:", e);
                }
            }

            if (!loaded && typeof localStorage !== 'undefined') {
                try {
                    const savedData = localStorage.getItem('drk_tariffs');
                    if (savedData) {
                        const data = JSON.parse(savedData);
                        const tariffs = data.tariffs || [];
                        const uploadDate = data.uploadDate ? new Date(data.uploadDate) : null;
                        
                        setState({
                            uploadedTariffs: tariffs,
                            config: { ...state.config, lastUploadDate: uploadDate },
                            retailerFilterOptions: [...new Set(tariffs.map(t=>t.retailer))],
                            segmentFilterOptions: [...new Set(tariffs.map(t=>t.segment))].sort(),
                            zoneFilterOptions: [...new Set(tariffs.map(t=>t.zone))].sort(), // NUEVO: Cargar opciones de zona
                        });
                        if (tariffs.length > 0) {
                            showNotification(`Tarifas cargadas de LocalStorage (${tariffs.length}). La persistencia es local.`, 'info');
                        }
                    } else if (isFirebaseReady) {
                        showNotification("No se encontraron tarifas guardadas en la Nube.", 'info');
                    } else {
                        showNotification("No se encontraron tarifas guardadas localmente.", 'info');
                    }
                } catch (e) {
                    console.error("Error al cargar tarifas de LocalStorage:", e);
                }
            }
        }

        async function saveTariffsToStorage(tariffs) {
            const now = new Date();
            const docData = { uploadDate: now.toISOString(), tariffs: tariffs };

            if (db && userId && isFirebaseReady) {
                const { doc, setDoc } = window.firebase;
                try {
                    const docRef = doc(db, 'artifacts', appId, 'users', userId, 'tariff_database', 'current_tariffs');
                    await setDoc(docRef, docData);
                    setState({ config: { ...state.config, lastUploadDate: now } });
                    console.log("Tariffs saved to Firestore successfully.");
                    showNotification("¡Tarifas guardadas en la Nube con éxito!", 'success');
                } catch (e) {
                    console.error("Error al guardar tarifas en Firestore:", e);
                    showNotification("Error al guardar tarifas en la Nube. Intentando LocalStorage...", 'error');
                }
            }
            
            if (typeof localStorage !== 'undefined') {
                try {
                    localStorage.setItem('drk_tariffs', JSON.stringify(docData));
                    setState({ config: { ...state.config, lastUploadDate: now } });
                    if (!isFirebaseReady) {
                        showNotification("Tarifas guardadas localmente (LocalStorage).", 'success');
                    }
                } catch (e) {
                    console.error("Error al guardar tarifas en LocalStorage:", e);
                    showNotification("Error al guardar tarifas localmente.", 'error');
                }
            }
        }
        
        async function deleteTariffsFromStorage() {
            if (state.uploadedTariffs.length === 0) {
                return showNotification("No hay tarifas cargadas para borrar.", 'info');
            }
            
            let deletedFromCloud = false;
            
            if (db && userId && isFirebaseReady) {
                const { doc, deleteDoc } = window.firebase;
                try {
                    const docRef = doc(db, 'artifacts', appId, 'users', userId, 'tariff_database', 'current_tariffs');
                    await deleteDoc(docRef);
                    deletedFromCloud = true;
                } catch (e) {
                    console.error("Error al borrar tarifas de Firestore:", e);
                }
            }
            
            if (typeof localStorage !== 'undefined') {
                localStorage.removeItem('drk_tariffs');
            }
            
            setState({
                uploadedTariffs: [],
                comparisonResults: [],
                result: null,
                retailerFilterOptions: [],
                segmentFilterOptions: [],
                zoneFilterOptions: [], // NUEVO: Resetear opciones de zona
                selectedRankingIds: [],
                config: {
                    ...state.config,
                    lastUploadDate: null,
                    segmentFilter: '', 
                    zoneFilter: '', // NUEVO: Resetear filtro de zona
                    winningTariffId: null,
                    retailerFilter: '',
                    rankingRetailerFilter: '',
                    winningRetailerFilter: ''
                }
            });
            showNotification(`¡Base de datos de tarifas eliminada con éxito! (Fuente: ${deletedFromCloud ? 'Nube y Local' : 'Solo Local'})`, 'success');
        }

        async function initializeFirebaseAndLoadData() {
            if (window.firebase) {
                const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, getFirestore, setLogLevel } = window.firebase;
                
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

                if (Object.keys(firebaseConfig).length > 0) {
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    
                    try {
                        let userCredential;
                        if (typeof __initial_auth_token !== 'undefined') {
                            userCredential = await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            userCredential = await signInAnonymously(auth);
                        }
                        userId = userCredential.user.uid;
                        isFirebaseReady = true; 
                    } catch (e) {
                        console.error("Error al autenticar o cargar datos (Conexión Nube Fallida):", e);
                        isFirebaseReady = false; 
                        showNotification("La conexión a la Nube (Firebase) falló. Usando LocalStorage para guardar/cargar tarifas.", 'error');
                    }
                } else {
                    isFirebaseReady = false;
                    console.warn("Falta la configuración de Firebase. La persistencia está deshabilitada (Usando LocalStorage).");
                }
            } else {
                isFirebaseReady = false;
                console.error("Módulos de Firebase no cargados.");
            }

            await loadTariffsFromStorage(); 
            renderUI(); 
        }

        // --- V4.55 Initialization Entry Point ---
        function initializeApp() { 
            resetAllState();
            state.config.tariff = '3.0TD';
            state.config.isMultiCupsMode = false;
            
            initializeFirebaseAndLoadData();
        }

        // --- UTILIDADES ---
        const formatCurrency = (n, d=2) => {
            if (typeof n !== 'number' || isNaN(n) || !isFinite(n)) return '0';
            return new Intl.NumberFormat('es-ES', { minimumFractionDigits: d, maximumFractionDigits: d }).format(n);
        };
        const parseNumericInput = (v) => {
            if (!v && v !== 0) return 0;
            if (typeof v === 'number') return v;
            let s = String(v).trim();
            if (s.includes('.') && s.includes(',')) s = s.replace(/\./g, "").replace(",", ".");
            else if (s.includes(',')) s = s.replace(",", ".");
            return parseFloat(s) || 0;
        };
        
        function getTariffPeriods(model) {
            const m = model ? model.toUpperCase().trim() : '';
            if (m.includes('RL')) {
                 // GAS RLx: 1 Periodo Potencia (Término Fijo Anual), 1 Periodo Energía (Consumo Total)
                 return { p: 1, e: 1 };
            }
            const isHV = m.includes('3.0TD') || m.includes('6.1TD');
            return {
                p: isHV ? 6 : 2, 
                e: isHV ? 6 : 3 
            };
        }

        function getTariffCategory(model) {
            const m = model ? model.toUpperCase().trim() : '';
            if (m.includes('2.0TD')) return '2.0TD';
            if (m.includes('3.0TD')) return '3.0TD';
            if (m.includes('6.1TD')) return '6.1TD';
            if (m.includes('RL')) return 'GAS-RL'; // NUEVO: Categoría Gas
            return 'OTHER';
        }

        function getEmailTarget() {
            return state.config.brand === 'DRK' ? 'f.araujo@drk.es' : 'f.araujo@powercup.es';
        }

        // --- HANDLERS (INPUT FIX) ---
        function handleInputRaw(name, value, type = 'inputs') {
             if (['clientName', 'cups', 'commercialCode'].includes(name)) {
                 state.inputs[name] = String(value).trim();
             } else {
                 state.inputs[name] = parseNumericInput(value);
             }
        }
        function handleInputBlur(name, value, type = 'inputs') {
            const val = ['clientName', 'cups', 'commercialCode'].includes(name) ? String(value).trim() : parseNumericInput(value);
            if (type === 'inputs') { state.inputs[name] = val; setState({ inputs: state.inputs }); }
            else { state.currentPrices[name] = val; setState({ currentPrices: state.currentPrices }); }
        }

        // --- HANDLERS GENERALES ---
        function setState(ns) { 
            Object.assign(state, ns); 
            if (state.config.winningTariffId) {
                const winningPlan = state.comparisonResults.find(p => p.id === state.config.winningTariffId);
                if (winningPlan && state.result?.current) {
                    state.result.bestPlan = winningPlan;
                }
            }
            renderUI(); 
        }

        function handleBrandChange(e) {
            const newBrand = e.target.value;
            const isDrk = newBrand === 'DRK';
            const newHeader = isDrk ? 'DRK Energía | Comercializadora' : 'POWER CUP | Asesoría Energética';
            
            setState({ 
                config: { 
                    ...state.config, 
                    brand: newBrand, 
                    reportHeader: newHeader, 
                    segmentFilter: '', 
                    zoneFilter: '', // NUEVO: Resetear filtro de zona
                    winningRetailerFilter: '', 
                    isSinglePresentationMode: isDrk ? true : state.config.isSinglePresentationMode 
                }, 
                result: null, 
                comparisonResults: [] 
            });
        }

        function handleTariffChange(e) { 
            const newTariff = e.target.value;

            if (state.config.isMultiCupsMode) {
                const savedMultiCupsData = [...state.multiCupsData];
                const savedCurrentCupsIndex = state.currentCupsIndex;
                const savedClientName = state.inputs.clientName;
                const savedCommercialCode = state.inputs.commercialCode;
                
                state.inputs = { 
                    clientName: savedClientName, 
                    cups: '', 
                    commercialCode: savedCommercialCode, 
                    p1_kw: 0, p2_kw: 0, p3_kw: 0, p4_kw: 0, p5_kw: 0, p6_kw: 0, 
                    p1_kwh: 0, p2_kwh: 0, p3_kwh: 0, p4_kwh: 0, p5_kwh: 0, p6_kwh: 0, 
                    clientTotalInvoice: 0 
                };
                
                state.comparisonResults = [];
                state.result = null;
                state.selectedRankingIds = [];
                state.currentStudyResult = null;
                
                state.config.tariff = newTariff;
                state.config.segmentFilter = '';
                state.config.zoneFilter = ''; // NUEVO: Resetear filtro de zona
                state.config.winningTariffId = null;


                setState({ 
                    config: state.config,
                    inputs: state.inputs,
                    multiCupsData: savedMultiCupsData,
                    currentCupsIndex: savedCurrentCupsIndex,
                });
                showNotification(`Modelo de tarifa cambiado a ${newTariff}. Listo para el siguiente CUPS.`, 'info');

            } else {
                resetAllState();
                setState({ 
                    config: { ...state.config, tariff: newTariff, segmentFilter: '', zoneFilter: '' }, // NUEVO: Resetear filtro de zona
                    result: null, 
                    comparisonResults: [] 
                }); 
            }
        }
        
        function handleMultiCupsModeChange(e) {
            const isChecked = e.target.checked;
            const currentBrand = state.config.brand;
            const currentTariff = state.config.tariff;

            resetAllState(); 
            setState({ 
                config: { ...state.config, isMultiCupsMode: isChecked, brand: currentBrand, tariff: currentTariff },
                currentCupsIndex: isChecked ? 1 : 0
            });
            showNotification(isChecked ? "Modo Multi-CUPS activado. Comience con el CUPS #1." : "Modo simple activado.", 'info');
        }

        function handleConfigChange(n, v) { 
            // Permite modificar los días manualmente SOLO si NO es 2.0TD ni GAS-RL
            if (n === 'days') v = parseNumericInput(v); 
            if (n === 'isSinglePresentationMode') v = (v === 'true' || v === true);
            
            // Si la tarifa es 2.0TD o GAS-RL y el campo de días está deshabilitado, se mantiene el valor original.
            if (['2.0TD', 'GAS-RL'].includes(state.config.tariff) && n === 'days') {
                setState({ config: state.config }); 
                return; 
            }
            
            setState({ config: { ...state.config, [n]: v }, result: null }); 
        }
        function handleReportHeaderChange(e) { setState({ config: { ...state.config, reportHeader: e.target.value } }); }
        function handleRetailerFilterChange(e) { setState({ config: { ...state.config, retailerFilter: e.target.value } }); }
        function handleSegmentFilterChange(e) { setState({ config: { ...state.config, segmentFilter: e.target.value } }); }
        function handleZoneFilterChange(e) { setState({ config: { ...state.config, zoneFilter: e.target.value } }); } // NUEVO: Handler de Zona
        
        function handleRankingRetailerFilterChange(e) { 
            setState({ config: { ...state.config, rankingRetailerFilter: e.target.value } }); 
        }
        
        function handleWinningRetailerFilterChange(e) { 
            setState({ config: { ...state.config, winningRetailerFilter: e.target.value, winningTariffId: null } }); 
        }


        // --- LOGICA QR SCANNER (NUEVO) ---
        
        // Mapea los datos del QR (CNMC) a los campos de entrada de la aplicación
        window.applyQRData = function(data) {
            if (state.config.tariff !== '2.0TD') return showNotification("Error: Los datos de CNMC QR solo se aplican a 2.0TD.", "error");

            // Potencia (kW) - Claves CNMC: pP1, pP2
            const p1_kw = parseFloat(data.pP1) || 0; 
            const p2_kw = parseFloat(data.pP2) || 0;
            
            // Energía (kWh) - Claves CNMC: cfP1, cfP2, cfP3
            const p1_kwh = parseFloat(data.cfP1) || 0; // Consumo Punta (E1)
            const p2_kwh = parseFloat(data.cfP2) || 0; // Consumo Llano (E2)
            const p3_kwh = parseFloat(data.cfP3) || 0; // Consumo Valle (E3)
            
            // Importe Total Facturado - Clave CNMC: imp
            const clientTotalInvoice = parseFloat(data.imp) || 0; 
            
            // Consumo total (Calculado)
            const totalConsumption = p1_kwh + p2_kwh + p3_kwh;
            
            // --- INICIO: CÁLCULO AUTOMÁTICO DE DÍAS (2.0TD) ---
            let newDays = state.config.days; // Mantener el valor actual por defecto
            let daysCalculated = false;

            if (data.iniF && data.finF) {
                try {
                    // Crea fechas. Usamos YYYY-MM-DD.
                    const startDate = new Date(data.iniF);
                    const endDate = new Date(data.finF);

                    // Para asegurar que no hay problemas de zona horaria que puedan sumar/restar 1 día:
                    startDate.setHours(0, 0, 0, 0);
                    endDate.setHours(0, 0, 0, 0);
                    
                    // Diferencia de tiempo en milisegundos
                    const timeDiff = endDate.getTime() - startDate.getTime();
                    
                    // Convertir a días.
                    const diffDays = Math.round(timeDiff / (1000 * 3600 * 24)); 
                    
                    // Si diffDays es 30, son 31 días de servicio. Si diffDays es 30, newDays = 31.
                    const finalDays = diffDays + 1; // Ajuste común para facturas
                    
                    if (finalDays > 0 && finalDays < 366) {
                        newDays = finalDays;
                        daysCalculated = true;
                    } else {
                        console.error("Días calculados inválidos:", finalDays);
                    }
                } catch(e) {
                    console.error("Error al calcular días de la factura:", e);
                }
            }
            // --- FIN: CÁLCULO AUTOMÁTICO DE DÍAS ---
            
            const newInputs = {
                ...state.inputs,
                cups: data.cups ? String(data.cups).trim().toUpperCase() : state.inputs.cups,
                clientTotalInvoice: clientTotalInvoice,

                // Aplicar Potencia
                p1_kw: p1_kw,
                p2_kw: p2_kw,

                // Aplicar Energía
                p1_kwh: p1_kwh,
                p2_kwh: p2_kwh,
                p3_kwh: p3_kwh,
                
                // Asegurar que los periodos de tarifas HV están a 0
                p4_kw: 0, p5_kw: 0, p6_kw: 0,
                p4_kwh: 0, p5_kwh: 0, p6_kwh: 0,
            };
            
            // Llamada a setState para disparar la actualización de la UI con los nuevos valores.
            const newState = {
                inputs: newInputs,
                config: { ...state.config, days: newDays }, // CLAVE: Reconstruir config para forzar la actualización del campo days
                showQRScannerModal: false
            };
            
            setState(newState);

            // Si se cumplieron las condiciones de cálculo, lo disparamos con el nuevo estado:
            if (state.config.segmentFilter && state.config.zoneFilter && clientTotalInvoice > 0) {
                // Se llama después de setState para que el estado global (incluyendo newDays) esté actualizado
                calculate();
                if (daysCalculated) {
                    showNotification(`¡Datos de factura 2.0TD cargados! Días: ${newDays}. Calculando...`, "success");
                } else {
                    showNotification(`¡Datos de factura 2.0TD cargados! Consumo total: ${formatCurrency(totalConsumption, 0)} kWh. Calculando...`, "success");
                }
            } else {
                if (daysCalculated) {
                    showNotification(`¡Datos de factura 2.0TD cargados! Días (${newDays}) y CUPS OK. Falta Segmento y/o Zona para calcular.`, "info");
                } else {
                    showNotification(`¡Datos de factura 2.0TD cargados! Consumo total: ${formatCurrency(totalConsumption, 0)} kWh. Falta Segmento y/o Zona para calcular.`, "info");
                }
            }
        }
        
        function openQRScanner() {
            if (state.config.tariff !== '2.0TD') {
                return showNotification("El escáner QR de CNMC solo está disponible para tarifas 2.0TD.", "info");
            }
            setState({ showQRScannerModal: true });
        }


        // --- LOGICA MULTI-CUPS (SE MANTIENE) ---
        function saveCupsAndProceed() {
            if (!state.currentStudyResult || !state.inputs.cups) {
                return showNotification("¡Atención! Debe haber un CUPS calculado y un valor de CUPS ingresado.", 'error');
            }
            
            const cupsData = {
                cupsIndex: state.currentCupsIndex,
                clientName: state.inputs.clientName,
                cups: state.inputs.cups,
                tariffModel: state.config.tariff,
                savings: state.currentStudyResult.bestPlan.savings,
                periodCost: state.currentStudyResult.bestPlan.periodCost,
                annualCost: state.currentStudyResult.bestPlan.annualCost,
                plan: state.currentStudyResult.bestPlan, 
                inputs: { ...state.inputs }
            };
            
            const newMultiCupsData = [...state.multiCupsData, cupsData];
            
            const newInputs = { clientName: state.inputs.clientName, cups: '', commercialCode: state.inputs.commercialCode, p1_kw: 0, p2_kw: 0, p3_kw: 0, p4_kw: 0, p5_kw: 0, p6_kw: 0, p1_kwh: 0, p2_kwh: 0, p3_kwh: 0, p4_kwh: 0, p5_kwh: 0, p6_kwh: 0, clientTotalInvoice: 0 };

            setState({
                multiCupsData: newMultiCupsData,
                currentCupsIndex: state.currentCupsIndex + 1,
                inputs: newInputs,
                currentStudyResult: null, 
                comparisonResults: [],
                result: null,
                config: { 
                    ...state.config, 
                    segmentFilter: '', 
                    zoneFilter: '', // NUEVO: Resetear filtro de zona
                    winningTariffId: null,
                    rankingRetailerFilter: '',
                    winningRetailerFilter: ''
                }
            });
            
            showNotification(`CUPS ${cupsData.cupsIndex} (${cupsData.cups}) guardado. Listo para CUPS #${state.currentCupsIndex + 1}.`, 'success');
        }

        function finalizeMultiCups() {
            let newMultiCupsData = [...state.multiCupsData];
            
            if (state.currentStudyResult && state.inputs.cups) {
                const cupsData = {
                    cupsIndex: state.currentCupsIndex,
                    clientName: state.inputs.clientName,
                    cups: state.inputs.cups,
                    tariffModel: state.config.tariff,
                    savings: state.currentStudyResult.bestPlan.savings,
                    periodCost: state.currentStudyResult.bestPlan.periodCost,
                    annualCost: state.currentStudyResult.bestPlan.annualCost,
                    plan: state.currentStudyResult.bestPlan,
                    inputs: { ...state.inputs }
                };
                newMultiCupsData.push(cupsData);
            } else if (state.multiCupsData.length === 0) {
                return showNotification("No hay estudios de CUPS guardados para consolidar.", 'error');
            }
            
            setState({
                multiCupsData: newMultiCupsData,
                currentStudyResult: null, 
                isFinalReportVisible: true
            });
            showNotification(`¡Informe consolidado de ${newMultiCupsData.length} CUPS listo!`, 'success');
        }

        function returnToCupsEntry() {
            const nextIndex = state.multiCupsData.length + 1;
            
            const lastClientName = state.multiCupsData.length > 0 ? state.multiCupsData[0].clientName : '';
            const lastCommercialCode = state.multiCupsData.length > 0 ? state.multiCupsData[0].inputs.commercialCode : state.inputs.commercialCode;
            
            const newInputs = { 
                clientName: lastClientName, 
                cups: '', 
                commercialCode: lastCommercialCode, 
                p1_kw: 0, p2_kw: 0, p3_kw: 0, p4_kw: 0, p5_kw: 0, p6_kw: 0, 
                p1_kwh: 0, p2_kwh: 0, p3_kwh: 0, p4_kwh: 0, p5_kwh: 0, p6_kwh: 0, 
                clientTotalInvoice: 0 
            };
            
            const lastTariffModel = state.multiCupsData[state.multiCupsData.length - 1]?.tariffModel || state.config.tariff;

            setState({
                isFinalReportVisible: false,
                currentCupsIndex: nextIndex,
                inputs: newInputs,
                currentStudyResult: null,
                comparisonResults: [],
                result: null,
                config: {
                    ...state.config,
                    tariff: lastTariffModel,
                    segmentFilter: '',
                    zoneFilter: '', // NUEVO: Resetear filtro de zona
                    winningTariffId: null,
                    isMultiCupsMode: true
                }
            });
            showNotification(`Continuando estudio. Listo para CUPS #${nextIndex}.`, 'info');
        }

        // --- LOGICA RANKING (SE MANTIENE) ---
        function getSelectedRetailers(ids, results) {
            const s = new Set();
            ids.forEach(id => { const r = results.find(x => x.id === id); if(r) s.add(r.retailer); });
            return s;
        }
        
        function handleWinningSelection(e) {
            const id = e.target.value;
            setState({ config: { ...state.config, winningTariffId: id } });

            if (id !== '' && !state.selectedRankingIds.includes(id)) {
                let newIds = [...state.selectedRankingIds].filter(x => x !== id); 
                const t = state.comparisonResults.find(r => r.id === id);
                if (!t) return;
                const existing = getSelectedRetailers(newIds, state.comparisonResults);
                
                if (!existing.has(t.retailer)) {
                    if (newIds.length < 5) newIds.push(id);
                }

                setState({ selectedRankingIds: newIds });
            }
        }

        function handleRankingSelection(id, isChecked) {
            let newIds = [...state.selectedRankingIds];
            const t = state.comparisonResults.find(r => r.id === id);
            if (!t) return;

            if (isChecked) {
                const winningPlan = state.comparisonResults.find(r => r.id === state.config.winningTariffId);
                if (winningPlan && winningPlan.retailer === t.retailer) {
                    showNotification(`La comercializadora ${t.retailer} ya es la tarifa ganadora seleccionada.`, 'info');
                    renderUI(); 
                    return;
                }
                
                const existing = getSelectedRetailers(newIds, state.comparisonResults);
                if (existing.has(t.retailer)) { 
                    showNotification(`Ya existe otra tarifa de ${t.retailer} en el ranking.`, 'info'); 
                    renderUI(); 
                    return; 
                }
                if (newIds.length < 5) newIds.push(id);
                else { showNotification("Máximo 5 tarifas permitidas en el ranking.", 'info'); renderUI(); return; }
            } else {
                newIds = newIds.filter(x => x !== id);
            }
            setState({ selectedRankingIds: newIds });
        }
        
        function resetRankingSelection() {
            setState({ selectedRankingIds: [] });
            showNotification("Ranking de opciones reseteado.", "info");
        }

        // --- CÁLCULOS EXCEL Y PRINCIPAL ---
        
        // Mapeo actualizado: Cía(A:0), Tarifa(B:1), Modelo(D:3), Zona(E:4)
        // E1-E6 (K:10 - P:15), Desc. Energía (Q:16), 
        // P1-P6 (R:17 - W:22), Desc. Potencia (X:23), Segmento (AI:34)
        const EXCEL_MAP = { 
            retailer: 0, 
            tariffName: 1, 
            tariffModel: 3, 
            zone: 4, // NUEVO: Columna E (4)
            
            p1_en: 10, p2_en: 11, p3_en: 12, p4_en: 13, p5_en: 14, p6_en: 15, // K-P
            en_discount: 16, // Q
            
            p1_pow_an: 17, p2_pow_an: 18, p3_pow_an: 19, p4_pow_an: 20, p5_pow_an: 21, p6_pow_an: 22, // R-W
            pow_discount: 23, // X
            
            segment: 34 // AI
        };
        
        function handleExcelUpload(e) {
            const f = e.target.files[0]; if(!f) return;
            setState({ isScanning: true, scanStatus: "Procesando..." });
            const r = new FileReader();
            r.onload = (e) => {
                try {
                    const wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                    const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { header: 1, raw: false });
                    if(json.length < 2) throw new Error("Vacio");
                    const segs = new Set();
                    const zones = new Set(); // NUEVO: Conjunto de zonas
                    const uniqueTariffs = new Map(); // Para desduplicación

                    json.slice(1).forEach((row, i) => {
                        const s = String(row[EXCEL_MAP.segment]||'').toUpperCase().trim();
                        const m = String(row[EXCEL_MAP.tariffModel]||'').toUpperCase().trim();
                        const z = String(row[EXCEL_MAP.zone]||'').toUpperCase().trim(); // NUEVO: Capturar zona
                        const r = String(row[EXCEL_MAP.retailer]||'Desc').toUpperCase().trim();
                        const n = String(row[EXCEL_MAP.tariffName]||`T${i}`);
                        
                        // CLAVE CRÍTICA DE DESDUPLICACIÓN: Debe incluir la zona y el modelo.
                        const uniqueKey = `${r}|${n}|${m}|${z}`; 

                        // Si ya existe una tarifa con la misma clave, ignorarla.
                        if (uniqueTariffs.has(uniqueKey)) return;

                        if(s) segs.add(s);
                        if(z) zones.add(z); // NUEVO: Añadir zona a las opciones
                        
                        const t = {
                            id: `t-${i}-${m}`, retailer: r, name: n, model: m, segment: s, zone: z, // NUEVO: Añadir zona
                            
                            // Se mapean los 6 periodos de Potencia (R-W) y Energía (K-P)
                            pow_an: Array(6).fill(0).map((_,j)=>parseNumericInput(row[EXCEL_MAP.p1_pow_an+j])||0),
                            en: Array(6).fill(0).map((_,j)=>parseNumericInput(row[EXCEL_MAP.p1_en+j])||0),
                            pow_discount: parseNumericInput(row[EXCEL_MAP.pow_discount]||0)/100, en_discount: parseNumericInput(row[EXCEL_MAP.en_discount]||0)/100
                        };
                        
                        // Ajuste de arrays para 2.0TD
                        if (m.includes('2.0TD')) { 
                            t.pow_an = t.pow_an.slice(0, 2); 
                            t.en = t.en.slice(0, 3);
                        }
                        
                        // Ajuste de arrays para GAS-RL (1 Periodo Fijo, 1 Periodo Energía)
                        if (m.includes('RL')) {
                            t.pow_an = t.pow_an.slice(0, 1);
                            t.en = t.en.slice(0, 1);
                        }


                        uniqueTariffs.set(uniqueKey, t);
                    });
                    
                    const tariffs = Array.from(uniqueTariffs.values());
                    saveTariffsToStorage(tariffs);

                    setState({ 
                        uploadedTariffs: tariffs, 
                        retailerFilterOptions: [...new Set(tariffs.map(t=>t.retailer))], 
                        segmentFilterOptions: [...segs].sort(), 
                        zoneFilterOptions: [...zones].sort(), // NUEVO: Setear opciones de zona
                        isScanning: false, 
                        comparisonResults: [],
                        config: { 
                            ...state.config, 
                            winningTariffId: null,
                            lastUploadDate: new Date() 
                        }
                    });
                    showNotification(`${tariffs.length} tarifas importadas.`, 'success');
                } catch(err) { setState({ isScanning: false }); showNotification("Error al procesar el Excel. Verifica el formato.", 'error'); }
            };
            r.readAsArrayBuffer(f);
        }

        const roundInternal = (n) => Math.round(n * 1000000) / 1000000;
        const roundExternal = (n) => Math.round(n * 100) / 100;

        function calculateTariffCost(t, inp) {
            const periods = getTariffPeriods(t.model);
            const pPeriods = periods.p; 
            const ePeriods = periods.e;
            let cP = 0, cE = 0;

            if (t.model.toUpperCase().includes('RL')) {
                 // ** CÁLCULO ESPECÍFICO PARA GAS RLx **
                 const days = state.config.days;
                 const consumption = inp.p1_kwh || 0;

                 // Termino Fijo Anual (€/año) -> t.pow_an[0] (R:17)
                 const fixedPriceAnnual = t.pow_an[0] || 0;
                 const energyPrice = t.en[0] || 0; // Termino de Energía (€/kWh) -> t.en[0] (K:10)

                 // 1. CÁLCULO TÉRMINO FIJO
                 const fixedPriceDaily = fixedPriceAnnual / 365;
                 cP = fixedPriceDaily * days;

                 // 2. CÁLCULO TÉRMINO DE ENERGÍA (Consumo)
                 cE = consumption * energyPrice * (1 - (t.en_discount || 0));

            } else {
                 // ** CÁLCULO PARA ELECTRICIDAD (TD/HV) **
                for(let i=0; i<pPeriods; i++) {
                    const kw = inp[`p${i+1}_kw`];
                    const annualPrice = t.pow_an[i]||0; 
                    const dailyPriceDiscounted = (annualPrice * (1-(t.pow_discount||0))) / 365;
                    cP += (kw || 0) * state.config.days * dailyPriceDiscounted;
                }
                for(let i=0; i<ePeriods; i++) {
                    const kwh = inp[`p${i+1}_kwh`];
                    const priceDiscounted = (t.en[i]||0) * (1-(t.en_discount||0));
                    cE += (kwh || 0) * priceDiscounted;
                }
            }
            
            return { power: cP, energy: cE, total: roundInternal(cP + cE) };
        }
        
        function calculateTaxes(b, tariffModel) {
            let ie = 0;
            const m = tariffModel.toUpperCase();

            if (m.includes('RL')) {
                 // ** IMPUESTOS PARA GAS RLx **
                 // b: Base Imponible, que ya incluye el Impuesto HC en el Gas.
                 // Impuesto HC = Consumo * 0.00234
                 const consumption = state.inputs.p1_kwh || 0;
                 ie = consumption * IMPUESTO_HC_RATE; // En este contexto, 'ie' representa el Impuesto HC para el reporte
                 
                 // La base imponible para el IVA debe ser la suma de (T.Fijo + T.Energía + Impuesto HC)
                 // Como 'b' en este punto ya es (T.Fijo + T.Energía + Impuesto HC),
                 // usamos 'b' para calcular el IVA.
                 
            } else {
                 // ** IMPUESTOS PARA ELECTRICIDAD **
                 // Impuesto Eléctrico (5% sobre Potencia + Energía Base)
                 ie = (b) * 0.05;
            }

            // Cálculo del IVA (21% sobre Base Imponible + Impuesto Eléctrico / Impuesto HC)
            const baseForIVA = b + (m.includes('RL') ? 0 : ie); // Si es GAS, el Impuesto HC (ie) ya está incluido en 'b'

            const iva = baseForIVA * IVA_RATE;
            
            // Base Imponible Real (antes de IVA, después de IE/Imp.HC)
            const realBaseImponible = b + (m.includes('RL') ? 0 : ie);
            
            return { 
                ie: roundInternal(m.includes('RL') ? ie : ie), 
                base_imponible: roundInternal(realBaseImponible), // Base Imponible para el reporte
                iva: roundInternal(iva), 
                total_periodo: roundInternal(realBaseImponible + iva),
                isGas: m.includes('RL')
            };
        }

        function calculate() {
            if(!state.uploadedTariffs.length) return showNotification("Falta archivo de tarifas", 'error');
            if(!state.config.segmentFilter) return showNotification("Falta seleccionar Segmento", 'error');
            if(!state.config.zoneFilter) return showNotification("Falta seleccionar Zona Geográfica", 'error'); // NUEVO: Validación de zona
            
            const days = state.config.days;
            const tariffModel = state.config.tariff;

            if (tariffModel === 'GAS-RL' && (!state.inputs.p1_kwh || state.inputs.p1_kwh <= 0)) {
                 return showNotification("Falta Consumo de Gas (kWh/Sm3)", 'error');
            }
            if (!tariffModel.includes('GAS') && state.inputs.clientTotalInvoice <= 0) {
                 return showNotification("Falta Total Factura (Electricidad)", 'error');
            }


            if(state.config.isMultiCupsMode && (!state.inputs.cups || !state.inputs.clientName)) {
                 return showNotification("En modo Multi-CUPS, se requiere Nombre Cliente y CUPS para el estudio.", 'error');
            }

            const annF = days===31 ? 12 : (365/days);
            let curTotal = 0, curAnn = 0, curBase = null;

            const t = state.inputs.clientTotalInvoice;
            // Cálculo del coste actual del cliente (solo funciona para electricidad con el QR de 2.0TD)
            // Se mantiene el cálculo basado en el total de la factura para que el ahorro sea exacto.
            curTotal = t; 
            curAnn = roundInternal(t * annF);
            // La base imponible actual del cliente es la factura total sin impuestos (21% IVA + 5% IE)
            // Para el cálculo de Gas, la Base Imponible del cliente no se necesita de forma tan estricta, pero se mantiene la estructura.
            // (1 + 0.05) * (1 + 0.21) = 1.05 * 1.21 = 1.2705
            curBase = { total: t / 1.2705 }; 

            const isDrkBrand = state.config.brand === 'DRK';

            const res = state.uploadedTariffs.filter(t => {
                const s = t.segment; 
                const f = state.config.segmentFilter;
                const z = t.zone; // Nueva variable de zona
                const fz = state.config.zoneFilter; // Nuevo filtro de zona
                const m = state.config.tariff; 
                
                // Filtro por Modelo: Electricidad (2.0TD, 3.0TD, 6.1TD) o Gas (RLx)
                // Para GAS, filtramos cualquier modelo que contenga 'RL' (RL1, RL2, etc.)
                if (m === 'GAS-RL') {
                    if (!t.model.toUpperCase().includes('RL')) return false;
                } else {
                    if (!t.model.toUpperCase().includes(m)) return false;
                }
                
                // --- INICIO: CORRECCIÓN PARA DRK ENERGÍA ---
                if (isDrkBrand) {
                    const retailerUpper = t.retailer.toUpperCase();
                    // Permite DRK, DRK ENERGIA, DRK ENERGÍA S.L., etc.
                    if (!retailerUpper.includes('DRK') && !retailerUpper.includes('DRK ENERGIA')) return false;
                }
                // --- FIN: CORRECCIÓN PARA DRK ENERGÍA ---
                
                // --- INICIO: FILTRO DE ZONA GEOGRÁFICA (COLUMNA E) ---
                if (fz && z !== fz) {
                    return false;
                }
                // --- FIN: FILTRO DE ZONA GEOGRÁFICA ---

                // --- INICIO: CORRECCIÓN LÓGICA DE FILTRO DE SEGMENTO (COLUMNA AI) ---
                if (f) {
                    const filterChars = f.split(''); // Ej: ['A', 'R']
                    let segmentMatchFound = false;

                    for (const char of filterChars) {
                        // Si el segmento de la tarifa (s) contiene AL MENOS un carácter del filtro (f)
                        if (s.includes(char)) {
                            segmentMatchFound = true;
                            break;
                        }
                    }
                    
                    if (!segmentMatchFound) {
                        return false;
                    }
                }
                // --- FIN: CORRECCIÓN LÓGICA DE FILTRO DE SEGMENTO ---
                
                if(!state.config.isMultiCupsMode && state.config.retailerFilter && t.retailer !== state.config.retailerFilter) return false;
                
                return true;
            }).map(t => {
                // 1. Calcular Coste Base (Potencia + Energía) ANTES de impuestos
                const b = calculateTariffCost(t, state.inputs);
                
                // 2. Calcular Impuestos y Total del Periodo
                const tx = calculateTaxes(b.total, t.model);
                
                // 3. Calcular Coste Anual y Ahorro
                const ann = roundInternal(tx.total_periodo * annF);
                const savings = roundInternal(curAnn - ann);
                
                return { 
                    ...t, 
                    periodCost: tx.total_periodo, 
                    annualCost: ann, 
                    savings: savings, 
                    taxes: tx, 
                    base_cost: b, 
                    tariffDetails: t 
                };
            }).sort((a,b) => b.savings - a.savings);

            if(!res.length) return showNotification("Sin resultados", 'info');
            
            const currentResult = res.find(p => p.id === state.config.winningTariffId) || res[0];

            const newResult = { 
                current: { period: curTotal, annual: curAnn, details: curBase }, 
                bestPlan: currentResult
            };

            const newState = {
                comparisonResults: res,
                result: newResult,
                config: { ...state.config, winningTariffId: state.config.winningTariffId || currentResult.id },
                selectedRankingIds: state.selectedRankingIds.filter(id => res.some(r => r.id === id)) 
            };

            if (state.config.isMultiCupsMode) {
                newState.currentStudyResult = newResult;
                setState(newState);
                showNotification(`Calculado CUPS #${state.currentCupsIndex}. ¡Selecciona tu ganador y continúa!`, 'success');
            } else {
                setState(newState);
                showNotification(`Calculado: ${res.length} tarifas.`, 'success');
            }
        }

        function getPricesForMail(plan) {
            const periods = getTariffPeriods(plan.model);
            const pPeriodsCount = periods.p;
            const ePeriodsCount = periods.e;

            const getPrices = (t) => {
                const pp = [], pe = [];
                // Si es Gas, solo el primer periodo de potencia (anual) y el primer periodo de energía (total) son relevantes
                if (plan.model.toUpperCase().includes('RL')) {
                    // T. Fijo Diario: (T.Fijo Anual * (1 - Desc. Potencia)) / 365
                    pp.push( (t.pow_an[0]*(1-t.pow_discount))/365 );
                    // T. Energía: T. Energía Base * (1 - Desc. Energía)
                    pe.push( t.en[0]*(1-t.en_discount) );
                } else {
                    for(let i=0; i<pPeriodsCount; i++) pp.push( (t.pow_an[i]*(1-t.pow_discount))/365 ); 
                    for(let i=0; i<ePeriodsCount; i++) pe.push( t.en[i]*(1-t.en_discount) ); 
                }
                return { pp, pe };
            };
            
            const prices = getPrices(plan.tariffDetails); 
            let priceDetails = '';
            const isGas = plan.model.toUpperCase().includes('RL');
            
            if (isGas) {
                // Para GAS
                priceDetails += `Término Fijo Diario (€/día): ${formatCurrency(prices.pp[0], 8)}\n`;
                priceDetails += `Término Energía (€/kWh): ${formatCurrency(prices.pe[0], 8)}\n`;
                priceDetails += `Impuesto HC (Constante): ${formatCurrency(IMPUESTO_HC_RATE, 8)} €/kWh\n`;

            } else {
                 // Para Electricidad
                for (let i = 0; i < pPeriodsCount; i++) {
                    priceDetails += `P${i+1} (Potencia - €/kW/día): ${formatCurrency(prices.pp[i], 8)}\n`;
                }
                for (let i = 0; i < ePeriodsCount; i++) {
                    priceDetails += `E${i+1} (Energía - €/kWh): ${formatCurrency(prices.pe[i], 8)}\n`;
                }
            }


            return priceDetails;
        }

        function generateMailtoLink(plan) {
            const brand = state.config.brand;
            const company = brand.toUpperCase(); 
            
            const subject = `${company} / ${state.inputs.clientName} / CUPS: ${state.inputs.cups} / Aceptacion de oferta`;
            const priceDetails = getPricesForMail(plan);
            const isGas = plan.model.toUpperCase().includes('RL');
            const totalConsumption = state.inputs.p1_kwh + state.inputs.p2_kwh + state.inputs.p3_kwh + state.inputs.p4_kwh + state.inputs.p5_kwh + state.inputs.p6_kwh;


            const body = 
`Estimados ${company},

Adjunto la documentación necesaria para la gestión del cambio de comercializadora.

--- DATOS DE LA OFERTA ---

Comercializadora y Tarifa: ${plan.retailer} - ${plan.name} (${plan.model})
Zona Geográfica: ${plan.zone}
Ahorro Anual Estimado: ${formatCurrency(plan.savings, 0)} €
Total Mensual Estimado: ${formatCurrency(plan.periodCost, 2)} €
Consumo Total Facturado: ${formatCurrency(totalConsumption, 0)} ${isGas ? 'kWh/Sm3' : 'kWh'}

--- DETALLE DE PRECIOS (€) ---
${priceDetails.trim()}
------------------------------

--- DATOS DEL CLIENTE ---

Nombre: ${state.inputs.clientName}
CUPS: ${state.inputs.cups}
Cód. Comercial: ${state.inputs.commercialCode}


--- DOCUMENTACIÓN REQUERIDA ---

Para formalizar el contrato, por favor, responde a este email adjuntando:
1. Foto del DNI/CIF (anverso y reverso).
2. Última factura (mínimo 3 meses de antigüedad).
3. Email de contacto para validación.
4. Teléfono de contacto.
5. Número de cuenta bancaria (IBAN).
`;
            const emailTarget = getEmailTarget(); 

            return `mailto:${emailTarget}?subject=${encodeURIComponent(subject.trim())}&body=${encodeURIComponent(body.trim())}`;
        }
        
        function getUniqueWinningPlans() {
            const uniquePlans = new Map();
            const cupsMap = new Map(); 

            state.multiCupsData.forEach(cupsData => {
                const plan = cupsData.plan;
                // CLAVE ÚNICA DE PLAN CONSOLIDADO: Incluye zona
                const key = `${plan.retailer}|${plan.name}|${plan.model}|${plan.zone}`; 

                if (!uniquePlans.has(key)) {
                    uniquePlans.set(key, plan);
                }

                if (!cupsMap.has(key)) {
                    cupsMap.set(key, []);
                }
                cupsMap.get(key).push(cupsData.cups);
            });

            return { plans: Array.from(uniquePlans.values()), cupsMap: cupsMap };
        }

        function generateMultiCupsMailtoLink() {
            if (state.multiCupsData.length === 0) return '';
            
            const { plans, cupsMap } = getUniqueWinningPlans();
            
            const totalSavings = state.multiCupsData.reduce((sum, c) => sum + (parseFloat(c.savings) || 0), 0);
            const clientName = state.multiCupsData[0]?.clientName || 'Cliente Consolidado';
            const commercialCode = state.multiCupsData[0]?.inputs?.commercialCode || state.inputs.commercialCode;
            const totalCups = state.multiCupsData.length;

            const brand = state.config.brand;
            const company = brand.toUpperCase();
            
            const subject = `${company} / ${clientName} / ESTUDIO CONSOLIDADO (${totalCups} CUPS) / Aceptacion de oferta`;
            
            let priceDetails = '';
            let cupsRelation = '';

            plans.forEach((plan, index) => {
                const prices = getPricesForMail(plan);
                const key = `${plan.retailer}|${plan.name}|${plan.model}|${plan.zone}`;
                const associatedCups = cupsMap.get(key) || [];

                priceDetails += `\n--- OFERTA ÚNICA #${index + 1} ---\n`;
                priceDetails += `Comercializadora: ${plan.retailer}\n`;
                priceDetails += `Tarifa: ${plan.name} (${plan.model})\n`;
                priceDetails += `Zona Geográfica: ${plan.zone}\n`;
                
                priceDetails += `CUPS Asociados: ${associatedCups.join(', ')}\n`;
                priceDetails += `\n--- DETALLE DE PRECIOS (€) ---\n`;
                priceDetails += `${prices.trim()}\n`;

                cupsRelation += `CUPS asociados a Oferta #${index + 1} (${plan.retailer} - ${plan.model}):\n`;
                cupsRelation += associatedCups.map(cups => `- ${cups}`).join('\n') + '\n';
            });


            const body = 
`Estimados ${company},

Adjunto la documentación necesaria para la gestión del cambio de comercializadora para los ${totalCups} suministros de ${clientName}.

--- RESUMEN CONSOLIDADO ---

Ahorro Anual Total Estimado: ${formatCurrency(totalSavings, 0)} €

--- DATOS DEL CLIENTE ---

Nombre: ${clientName}
Cód. Comercial: ${commercialCode}

--- DETALLE DE TARIFAS ÚNICAS Y PRECIOS ---
${priceDetails.trim()}

------------------------------
--- RELACIÓN DE CUPS POR OFERTA ---

${cupsRelation.trim()}

------------------------------
--- DOCUMENTACIÓN REQUERIDA (Necesaria por cada CUPS) ---

Para formalizar el contrato, por favor, responde a este email adjuntando por cada suministro (CUPS):
1. Foto del DNI/CIF (anverso y reverso).
2. Última factura (mínimo 3 meses de antigüedad).
3. Email de contacto para validación.
4. Teléfono de contacto.
5. Número de cuenta bancaria (IBAN).
`;
            const emailTarget = getEmailTarget(); 

            return `mailto:${emailTarget}?subject=${encodeURIComponent(subject.trim())}&body=${encodeURIComponent(body.trim())}`;
        }


        // --- RENDER FUNCTIONS ---
        function renderIcon(n, c) { return `<i data-lucide="${n}" class="${c}"></i>`; }

        function getDetailedSimulacroData(plan, studyInputs) { 
            const periods = getTariffPeriods(plan.model);
            const pPeriods = periods.p; 
            const ePeriods = periods.e;
            const days = state.config.days;
            const inputs = studyInputs; 
            const isGas = plan.model.toUpperCase().includes('RL');
            
            const getPrices = (t) => {
                const pp = [], pe = [];
                if (isGas) {
                    pp.push( (t.tariffDetails.pow_an[0]*(1-t.tariffDetails.pow_discount))/365 );
                    pe.push( t.tariffDetails.en[0]*(1-t.tariffDetails.en_discount) );
                } else {
                    for(let i=0; i<pPeriods; i++) pp.push( (t.tariffDetails.pow_an[i]*(1-t.tariffDetails.pow_discount))/365 );
                    for(let i=0; i<ePeriods; i++) pe.push( t.tariffDetails.en[i]*(1-t.tariffDetails.en_discount) );
                }
                return { pp, pe };
            };
            const prices = getPrices(plan);

            const simData = { power: [], energy: [], taxes: plan.taxes, baseImponible: plan.taxes.base_imponible };

            // DETALLE POTENCIA / TERMINO FIJO
            if (isGas) {
                 // GAS: TÉRMINO FIJO ANUAL
                 const fixedPriceAnnual = plan.tariffDetails.pow_an[0] || 0;
                 const fixedPriceDaily = prices.pp[0] || 0;
                 const cost = fixedPriceDaily * days;

                 simData.power.push({
                     name: `TÉRMINO FIJO (RL)`,
                     formula: `${formatCurrency(fixedPriceAnnual, 3)} €/año x ${days} días / 365 días`,
                     cost: cost,
                 });
            } else {
                // ELECTRICIDAD
                for (let i = 0; i < pPeriods; i++) {
                    const kw = inputs[`p${i+1}_kw`] || 0;
                    const dailyPrice = prices.pp[i] || 0; 
                    const cost = kw * days * dailyPrice;
                    simData.power.push({
                        name: `P${i+1}`,
                        formula: `${formatCurrency(kw, 3)} kW x ${days} días x ${formatCurrency(dailyPrice, 8)} €/kW/día`,
                        cost: cost,
                    });
                }
            }

            // DETALLE ENERGÍA / CONSUMO
            if (isGas) {
                 // GAS: TÉRMINO ENERGÍA (Consumo Total)
                 const kwh = inputs.p1_kwh || 0; // Consumo total
                 const kwhPrice = prices.pe[0] || 0; 
                 const cost = kwh * kwhPrice;
                 
                 simData.energy.push({
                     name: `CONSUMO TOTAL`,
                     formula: `${formatCurrency(kwh, 0)} kWh/Sm3 x ${formatCurrency(kwhPrice, 8)} €/kWh`,
                     cost: cost,
                 });

            } else {
                 // ELECTRICIDAD
                for (let i = 0; i < ePeriods; i++) {
                    const kwh = inputs[`p${i+1}_kwh`] || 0;
                    const kwhPrice = prices.pe[i] || 0; 
                    const cost = kwh * kwhPrice;
                    simData.energy.push({
                        name: `E${i+1}`,
                        formula: `${formatCurrency(kwh, 0)} kWh x ${formatCurrency(kwhPrice, 8)} €/kWh`,
                        cost: cost,
                    });
                }
            }

            return simData;
        }

        function renderReportModal() {
            if (!state.showReportModal || !state.result || !state.config.winningTariffId) return '';
            const plan = state.result.bestPlan;
            
            const cPrimary = '#7c2d12'; 
            const cAccent = '#ea580c'; 
            const cBgLight = '#fff7ed'; 
            const cBorder = '#fdba74'; 
            const cTableHead = cPrimary; 
            const cTextDark = '#111827'; 
            const cSavingsHighlight = cAccent; 
            const cOfferButton = cPrimary; 

            let ranked = [];
            const winningPlan = state.result.bestPlan; 
            const winningPlanId = state.config.winningTariffId;
            const isSingleMode = state.config.isSinglePresentationMode || plan.model.toUpperCase().includes('RL'); // Forzar modo simple si es Gas

            if(isSingleMode) {
                ranked = [winningPlan];
            }
            else if(state.selectedRankingIds.length > 0) {
                ranked = state.selectedRankingIds
                    .map(id => state.comparisonResults.find(r=>r.id===id))
                    .filter(x=>x);
                if (winningPlan && ranked.findIndex(p => p.id === winningPlanId) === -1) {
                    ranked.unshift(winningPlan);
                }
                ranked.sort((a,b) => b.savings - a.savings);

            } else {
                const used = new Set();
                for(const r of state.comparisonResults) {
                    if(!used.has(r.retailer)) { used.add(r.retailer); ranked.push(r); }
                    if(ranked.length >= 5) break;
                }
                if (winningPlan && ranked.findIndex(p => p.id === winningPlanId) === -1) {
                    ranked.unshift(winningPlan);
                }
            }

            const maxSav = Math.max(...ranked.map(r=>r.savings), 0.1);
            
            const isMultiComparativeMode = !isSingleMode && ranked.length > 1;

            const compareCols = isMultiComparativeMode ? ranked.slice(0, 4) : [winningPlan];
            
            const periods = getTariffPeriods(plan.model);
            const pPeriodsCount = periods.p;
            const ePeriodsCount = periods.e; 
            const isGas = plan.model.toUpperCase().includes('RL');


            const getPrices = (t) => {
                const pp = [], pe = [];
                // Se recalcula aquí para la tabla comparativa
                if (isGas) {
                    pp.push( (t.tariffDetails.pow_an[0]*(1-t.tariffDetails.pow_discount))/365 );
                    pe.push( t.tariffDetails.en[0]*(1-t.tariffDetails.en_discount) );
                } else {
                    for(let i=0; i<pPeriodsCount; i++) pp.push( (t.tariffDetails.pow_an[i]*(1-t.tariffDetails.pow_discount))/365 );
                    for(let i=0; i<ePeriodsCount; i++) pe.push( t.tariffDetails.en[i]*(1-t.tariffDetails.en_discount) );
                }
                return { pp, pe };
            };

            let compTableHtml = `<table style="width:100%;border-collapse:collapse;font-size:11px;border:1px solid ${cBorder};margin-bottom:20px;"><thead><tr style="background:${cTableHead};color:white;">
                <th style="padding:8px;text-align:left">CONCEPTO</th>
                ${compareCols.map(c => `<th style="padding:8px;text-align:center">${c.retailer}</th>`).join('')}
            </tr></thead><tbody>`;
            
            // FILAS DE POTENCIA / TÉRMINO FIJO
            if (isGas) {
                 compTableHtml += `<tr style="background:#fff"><td style="padding:6px;font-weight:bold;color:${cPrimary}">Término Fijo Diario (€/día)</td>
                 ${compareCols.map(c => `<td style="padding:6px;text-align:center">${formatCurrency(getPrices(c).pp[0],6)}</td>`).join('')}</tr>`;
            } else {
                for(let i=0; i<pPeriodsCount; i++) {
                    compTableHtml += `<tr style="background:${i%2===0?'#fff':cBgLight}"><td style="padding:6px;font-weight:bold;color:${cPrimary}">Potencia P${i+1} (€/kW/día)</td>
                    ${compareCols.map(c => `<td style="padding:6px;text-align:center">${formatCurrency(getPrices(c).pp[i],6)}</td>`).join('')}</tr>`;
                }
            }

            // FILAS DE ENERGÍA / CONSUMO
            if (isGas) {
                 compTableHtml += `<tr style="background:#fff;border-top:1px solid #eee"><td style="padding:6px;font-weight:bold;color:${cPrimary}">Término Energía (€/kWh)</td>
                 ${compareCols.map(c => `<td style="padding:6px;text-align:center">${formatCurrency(getPrices(c).pe[0],6)}</td>`).join('')}</tr>`;
            } else {
                for(let i=0; i<ePeriodsCount; i++) {
                    compTableHtml += `<tr style="background:${i%2===0?'#fff':cBgLight};border-top:1px solid #eee"><td style="padding:6px;font-weight:bold;color:${cPrimary}">Energía E${i+1} (€/kWh)</td>
                    ${compareCols.map(c => `<td style="padding:6px;text-align:center">${formatCurrency(getPrices(c).pe[i],6)}</td>`).join('')}</tr>`;
                }
            }
            
            if (isGas) {
                compTableHtml += `<tr style="background:#fff"><td style="padding:6px;font-weight:bold;color:${cPrimary}">Impuesto HC (€/kWh)</td>
                ${compareCols.map(c => `<td style="padding:6px;text-align:center">${formatCurrency(IMPUESTO_HC_RATE, 6)}</td>`).join('')}</tr>`;
            }

            compTableHtml += `<tr style="border-top:2px solid ${cAccent};background:#fff7ed;font-weight:bold"><td style="padding:8px;color:${cAccent}">AHORRO ANUAL</td>
            ${compareCols.map(c => `<td style="padding:8px;text-align:center;color:${cAccent}">${formatCurrency(c.savings,0)} €</td>`).join('')}</tr>`;
            compTableHtml += `</tbody></table>`;

            const simData = getDetailedSimulacroData(plan, state.inputs); 
            const simTotalBase = simData.power.reduce((a,b)=>a+b.cost,0) + simData.energy.reduce((a,b)=>b.cost,0);
            
            const mailtoLink = generateMailtoLink(plan);
            const ieLabel = isGas ? 'Impuesto HC' : 'Impuesto Eléctrico (5%)';
            const ieCost = isGas ? plan.taxes.ie : plan.taxes.base_imponible - simTotalBase; // Ajuste para el Impuesto HC/IE


            const simHtml = `
                <div style="font-size: 12px; color: ${cTextDark};">
                    <h4 style="font-size: 16px; font-weight: bold; color: ${cPrimary}; text-align: center; margin: 20px 0; border-bottom: 2px solid ${cAccent}; padding-bottom: 5px;">
                        SIMULACIÓN ${plan.retailer} - ${plan.name}
                    </h4>

                    <table style="width:100%; border-collapse: collapse; margin-top: 10px;">
                        <tr style="background:${cPrimary}; color: white; font-weight: bold;"><td colspan="3" style="padding: 6px;">${isGas ? 'TÉRMINO FIJO Y ENERGÍA' : `TÉRMINO POTENCIA (${pPeriodsCount} Periodos)`}</td></tr>
                        ${simData.power.map(r => `
                            <tr style="border-bottom: 1px dashed #ddd; background: #fafafa;">
                                <td style="padding: 4px 8px; font-weight: bold; width: 10%;">${r.name}</td>
                                <td style="padding: 4px 8px; font-family: monospace; width: 65%;">${r.formula}</td>
                                <td style="text-align: right; padding: 4px 8px; width: 25%; font-weight: bold;">${formatCurrency(r.cost, 4)} €</td>
                            </tr>
                        `).join('')}
                        <tr style="font-weight: bold; background: #e2e8f0;"><td colspan="2" style="padding: 6px 8px; text-align: right;">SUBTOTAL ${isGas ? 'FIJO' : 'POTENCIA'}</td><td style="text-align: right; padding: 6px 8px;">${formatCurrency(simData.power.reduce((a,b)=>a+b.cost,0), 4)} €</td></tr>
                        
                        <tr style="background:${cPrimary}; color: white; font-weight: bold; border-top: 2px solid #fff;"><td colspan="3" style="padding: 6px;">${isGas ? 'TÉRMINO DE ENERGÍA (CONSUMO)' : `TÉRMINO ENERGÍA (${ePeriodsCount} Periodos)`}</td></tr>
                        ${simData.energy.map(r => `
                            <tr style="border-bottom: 1px dashed #ddd; background: #fafafa;">
                                <td style="padding: 4px 8px; font-weight: bold;">${r.name}</td>
                                <td style="padding: 4px 8px; font-family: monospace; width: 65%;">${r.formula}</td>
                                <td style="text-align: right; padding: 4px 8px; font-weight: bold;">${formatCurrency(r.cost, 4)} €</td>
                            </tr>
                        `).join('')}
                        <tr style="font-weight: bold; background: #e2e8f0;"><td colspan="2" style="padding: 6px 8px; text-align: right;">SUBTOTAL ${isGas ? 'CONSUMO' : 'ENERGÍA'}</td><td style="text-align: right; padding: 6px 8px;">${formatCurrency(simData.energy.reduce((a,b)=>a+b.cost,0), 4)} €</td></tr>
                        
                        <!-- IMPUESTOS ESPECIALES (IE o Impuesto HC) -->
                        <tr>
                            <td colspan="2" style="padding: 4px 8px; text-align: right;">+ ${ieLabel}</td>
                            <td style="text-align: right; padding: 4px 8px;">${formatCurrency(ieCost, 4)} €</td>
                        </tr>

                        <tr style="font-weight: bold; background: ${cBgLight}; border-top: 2px solid ${cAccent};"><td colspan="2" style="padding: 6px 8px; text-align: right; color: ${cPrimary};">BASE IMPONIBLE (P+E + ${isGas ? 'Impuesto HC' : 'Impuesto Eléctrico'})</td><td style="text-align: right; padding: 6px 8px; color: ${cPrimary};">${formatCurrency(plan.taxes.base_imponible, 4)} €</td></tr>
                        <tr><td colspan="2" style="padding: 4px 8px; text-align: right;">+ IVA (21%)</td><td style="text-align: right; padding: 4px 8px;">${formatCurrency(plan.taxes.iva, 4)} €</td></tr>
                        
                        <!-- UNIFICADO: TOTAL ANUAL (Fondo cPrimary) -->
                        <tr style="background:${cPrimary}; color: white; font-weight: bold; font-size: 14px;">
                            <td colspan="2" style="padding: 8px; text-align: right;">TOTAL ANUAL ESTIMADO</td>
                            <td style="text-align: right; padding: 8px;">${formatCurrency(plan.annualCost, 2)} €</td>
                        </tr>
                        
                        <!-- UNIFICADO: Total Mes (Fondo cAccent) -->
                        <tr style="background:${cAccent}; color: white; font-weight: bold; font-size: 14px;">
                            <td colspan="2" style="padding: 8px; text-align: right;">TOTAL MES (${state.config.days} DÍAS)</td>
                            <td style="text-align: right; padding: 8px;">${formatCurrency(plan.periodCost, 2)} €</td>
                        </tr>

                        <!-- UNIFICADO: Botón QUIERO OFERTA (Ahorro destacado añadido) -->
                        <tr style="background:#f0f9ff; border-top: 1px solid #dbeafe; border-bottom: 1px solid #dbeafe;">
                            <td colspan="3" style="padding: 10px 0; text-align: center;">
                                <div style="font-size: 14px; color: ${cPrimary}; font-weight: bold; margin-bottom: 5px;">
                                    TU AHORRO ANUAL ESTIMADO ES:
                                </div>
                                <div style="font-weight: 900; font-size: 36px; color: ${cAccent}; margin-bottom: 15px; line-height: 1;">
                                    ${formatCurrency(plan.savings, 0)} €
                                </div>
                                <div style="font-weight: 800; font-size: 18px; color: ${cAccent}; margin-bottom: 10px; text-transform: uppercase;">
                                    ¡CONSIGUE TU AHORRO ANUAL!
                                </div>
                                <a href="${mailtoLink}" style="display: inline-block; width: 60%; max-width: 300px; margin: 5px auto; text-align: center; background: ${cOfferButton}; color: white; padding: 12px 30px; border-radius: 8px; text-decoration: none; font-weight: bold; font-size: 14px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border: 1px solid ${cOfferButton};">
                                    QUIERO OFERTA
                                </a>
                                
                                <p style="margin-top: 15px; font-size: 11px; color: #666;">
                                    Contacto: <a href="mailto:${getEmailTarget()}" style="color: ${cPrimary}; text-decoration: underline;">${getEmailTarget()}</a>
                                </p>
                            </td>
                        </tr>
                    </table>
                </div>
            `;
            
            let rankingTableHtml = ''; // Inicialización para evitar ReferenceError
            let mainLayoutContent;
            
            if (isMultiComparativeMode) {
                // Generar el HTML para la tabla del ranking (columna derecha)
                rankingTableHtml = `
                    <h3 style="color:${cPrimary};border-bottom:2px solid ${cAccent};padding-bottom:5px;margin-bottom:15px;font-size:15px;font-weight:bold;text-transform:uppercase">Ranking de Opciones Seleccionadas (${ranked.length} Tarifas)</h3>
                    <table style="width:100%; border-collapse: collapse; font-size: 11px;">
                        <thead>
                            <tr style="background:${cTableHead}; color:white;">
                                <th style="padding: 6px; text-align: left;">CÍA / TARIFA</th>
                                <th style="padding: 6px; text-align: right;">AHORRO ANUAL</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${ranked.map((p, i) => `
                                <tr style="background:${i % 2 === 0 ? '#fff' : cBgLight};">
                                    <td style="padding: 6px; font-weight: bold; color: ${p.id === winningPlanId ? cAccent : cTextDark};">${p.retailer} (${p.name}) ${p.id === winningPlanId ? ' (Ganadora)' : ''}</td>
                                    <td style="padding: 6px; text-align: right; color: ${p.id === winningPlanId ? cAccent : cPrimary}; font-weight: bold;">${formatCurrency(p.savings, 0)} €</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;

                mainLayoutContent = `
                    <table border="0" cellpadding="0" cellspacing="0" style="width:100%;">
                        <tr>
                            <td style="width:65%; padding-right:20px; vertical-align:top;">
                                <h3 style="color:${cPrimary};border-bottom:2px solid ${cAccent};padding-bottom:5px;margin-bottom:15px;font-size:15px;font-weight:bold;text-transform:uppercase">Comparativa de Ofertas (Top ${compareCols.length})</h3>
                                ${compTableHtml}
                                <h3 style="color:${cPrimary};border-bottom:2px solid ${cAccent};padding-bottom:5px;margin-bottom:15px;margin-top:30px;font-size:15px;font-weight:bold;text-transform:uppercase">Simulación Detallada</h3>
                                ${simHtml}
                            </td>
                            <td style="width:35%; padding-left:20px; border-left:1px solid #eee; vertical-align:top;">
                                ${rankingTableHtml}
                            </td>
                        </tr>
                    </table>
                `;
            } else {
                mainLayoutContent = `
                    <div style="max-width: 600px; margin: 0 auto; text-align: center;">
                        <h3 style="color:${cPrimary};border-bottom:2px solid ${cAccent};padding-bottom:5px;margin-bottom:15px;font-size:15px;font-weight:bold;text-transform:uppercase">Resumen de Precios de la Oferta Única</h3>
                        ${compTableHtml}
                        <h3 style="color:${cPrimary};border-bottom:2px solid ${cAccent};padding-bottom:5px;margin-bottom:15px;margin-top:30px;font-size:15px;font-weight:bold;text-transform:uppercase">Simulación Detallada</h3>
                        ${simHtml}
                    </div>
                `;
            }


            return `
            <div id="reportModal" class="fixed inset-0 bg-black/80 flex justify-center items-center z-50 p-4">
                <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto flex flex-col">
                    <div class="flex justify-between p-4 border-b bg-slate-50 sticky top-0 z-20">
                        <h2 class="font-bold text-slate-700">Informe Comercial V4.55</h2>
                        <div class="flex gap-2">
                            <button onclick="copyVisualReport()" class="bg-orange-600 text-white px-3 py-1 rounded font-bold text-sm">COPIAR IMAGEN</button>
                            <button onclick="setState({showReportModal:false})" class="text-slate-500">✕</button>
                        </div>
                    </div>
                    <div class="p-8 bg-slate-100 overflow-auto">
                        <div id="visualReportContent" style="font-family:Arial,sans-serif;max-width:800px;margin:0 auto;background:#fff;box-shadow:0 4px 15px rgba(0,0,0,0.1)">
                            
                            <div style="background:${cBgLight};padding:30px;border-bottom:4px solid ${cAccent};">
                                <table border="0" cellpadding="0" cellspacing="0" style="width:100%;">
                                    <tr>
                                        <td style="width:50%;">
                                            <h1 style="color:${cAccent};font-size:26px;margin:0;font-weight:800">${state.config.brand.toUpperCase()}</h1>
                                            <p style="color:#666;margin:5px 0 0;font-size:13px">${state.config.brand === 'DRK' ? 'Comercializadora' : 'Asesoría Energética'}</p>
                                        </td>
                                        <td style="width:50%; text-align:right; vertical-align:top;">
                                            <div style="font-size:22px;font-weight:900;color:${cTextDark}">ESTUDIO DE AHORRO</div>
                                            <div style="color:${cPrimary};font-size:11px;text-transform:uppercase">Comparativa Profesional</div>
                                        </td>
                                    </tr>
                                </table>
                            </div>

                            <div style="padding:15px 30px;border-bottom:1px solid #eee;background:#fcfcfc;font-size:12px;color:#555">
                                <table border="0" cellpadding="0" cellspacing="0" style="width:100%;">
                                    <tr>
                                        <td>
                                            <strong>CLIENTE:</strong> ${state.inputs.clientName} | 
                                            <strong>CUPS:</strong> ${state.inputs.cups}
                                        </td>
                                        <td style="text-align:right;">
                                            <strong>GANADORA:</strong> ${plan.retailer} |
                                            <strong>TARIFA:</strong> ${plan.name} (${plan.model}) |
                                            <strong>ZONA:</strong> ${plan.zone}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td><strong>CÓDIGO COMERCIAL:</strong> ${state.inputs.commercialCode}</td>
                                        <td></td>
                                    </tr>
                                </table>
                            </div>

                            <div style="padding:30px">
                                <table border="0" cellpadding="0" cellspacing="0" style="width:100%; margin-bottom: 30px;">
                                    <tr>
                                        <td>
                                            <div style="background:${cBgLight};border:2px solid ${cAccent};border-radius:8px;padding:20px;width: 100%;">
                                                <table border="0" cellpadding="0" cellspacing="0" style="width:100%;">
                                                    <tr>
                                                        <td style="width: 50%; vertical-align: top;">
                                                            <div style="color:${cPrimary};font-size:12px;font-weight:bold;text-transform:uppercase">MEJOR OPCIÓN: ${plan.retailer}</div>
                                                            <div style="color:${cAccent};font-size:38px;font-weight:800;line-height:1">${formatCurrency(plan.savings,0)} €</div>
                                                            <div style="color:#666;font-size:12px;margin-top:5px">AHORRO ANUAL ESTIMADO</div>
                                                        </td>
                                                        <td style="width: 50%; text-align:right; vertical-align: top;">
                                                            <div style="font-size:12px;color:#666">Nuevo Coste Anual</div>
                                                            <div style="font-size:24px;font-weight:bold;color:${cPrimary}">${formatCurrency(plan.annualCost,2)} €</div>
                                                            <div style="font-size:11px;color:#888">vs. ${formatCurrency(state.result.current.annual,2)} € actuales</div>
                                                        </td>
                                                    </tr>
                                                </table>
                                            </div>
                                        </td>
                                    </tr>
                                </table>

                                ${mainLayoutContent}

                                <div style="margin-top:40px;border-top:1px solid #eee;padding-top:15px;display:flex;align-items:center;gap:15px">
                                    <div style="width:36px;height:36px;background:${cPrimary};color:white;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold">F</div>
                                    <div><div style="font-weight:bold;color:${cTextDark};font-size:13px">Fernando Araujo</div><div style="font-size:11px;color:#666">Consultor Energético | Tel: 615 43 94 28</div></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>`;
        }
        
        function renderMultiCupsReport() {
            if (!state.isFinalReportVisible || state.multiCupsData.length === 0) {
                return `<div class="p-8 text-center text-slate-500">No hay datos de CUPS guardados para el informe consolidado.</div>`;
            }

            let totalSavings = 0;
            let totalCurrentAnnualCost = 0;
            let totalNewAnnualCost = 0;
            const savingsByTariff = { '2.0TD': 0, '3.0TD': 0, '6.1TD': 0, 'GAS-RL': 0, 'OTHER': 0 }; 

            state.multiCupsData.forEach(cups => {
                const savings = parseFloat(cups.savings) || 0;
                const annualCost = parseFloat(cups.annualCost) || 0;
                
                totalSavings += savings;
                totalNewAnnualCost += annualCost;
                totalCurrentAnnualCost += (annualCost + savings); 
                
                const model = getTariffCategory(cups.tariffModel);
                savingsByTariff[model] += savings;
            });
            
            const mailtoLink = generateMultiCupsMailtoLink();
            const emailTarget = getEmailTarget();

            const cPrimary = '#7c2d12'; 
            const cAccent = '#ea580c'; 
            const cBgLight = '#fff7ed'; 
            const cTextDark = '#111827'; 
            const cSavingsHighlight = cAccent; 
            const cOfferButton = cPrimary; 

            const summaryHtml = `
                <div style="background:${cBgLight};border:2px solid ${cAccent};border-radius:8px;padding:20px;margin-bottom:30px;box-shadow:0 4px 6px -1px rgb(0 0 0 / 0.1);">
                    <h3 style="color:${cPrimary};font-size:18px;font-weight:bold;margin-bottom:15px;text-align: center; line-height: 1.2;">
                        ¡MAXIMIZA TU AHORRO! ANÁLISIS ESTRATÉGICO DE ${state.multiCupsData.length} SUMINISTROS
                    </h3>
                    <table border="0" cellpadding="0" cellspacing="0" style="width:100%; text-align:center;">
                        <tr>
                            <td style="width:33%; padding:10px; border-right:1px solid #eee;">
                                <div style="color:${cSavingsHighlight};font-size:32px;font-weight:800">${formatCurrency(totalSavings, 0)} €</div>
                                <div style="color:${cSavingsHighlight};font-size:16px;font-weight:bold; margin-top: 5px;">AHORRO TOTAL ANUAL ESTIMADO</div>
                            </td>
                            <td style="width:33%; padding:10px; border-right:1px solid #eee;">
                                <div style="color:${cTextDark};font-size:18px;font-weight:bold">${formatCurrency(totalCurrentAnnualCost, 2)} €</div>
                                <div style="color:#666;font-size:12px; margin-top: 5px;">Coste Anual Actual (Aprox.)</div>
                            </td>
                            <td style="width:33%; padding:10px;">
                                <div style="color:${cPrimary};font-size:18px;font-weight:bold">${formatCurrency(totalNewAnnualCost, 2)} €</div>
                                <div style="color:#666;font-size:12px; margin-top: 5px;">Nuevo Coste Anual Total</div>
                            </td>
                        </tr>
                    </table>
                    
                    <div style="margin-top:20px;padding-top:10px;border-top:1px solid ${cAccent};font-size:12px;background: #ffedd5; padding: 10px; border-radius: 4px;">
                        <h4 style="font-weight:bold;color:${cPrimary};margin-bottom:10px; font-size: 14px;">AHORRO DESGLOSADO POR MODELO DE TARIFA:</h4>
                        <table border="0" cellpadding="0" cellspacing="0" style="width:100%; font-size: 18px; font-weight: bold; color: ${cPrimary};">
                            <tr>
                                <td style="width:25%; text-align:center;">2.0TD: <span style="color: ${cAccent}">${formatCurrency(savingsByTariff['2.0TD'], 0)} €</span></td>
                                <td style="width:25%; text-align:center;">3.0TD: <span style="color: ${cAccent}">${formatCurrency(savingsByTariff['3.0TD'], 0)} €</span></td>
                                <td style="width:25%; text-align:center;">6.1TD: <span style="color: ${cAccent}">${formatCurrency(savingsByTariff['6.1TD'], 0)} €</span></td>
                                <td style="width:25%; text-align:center;">GAS-RL: <span style="color: ${cAccent}">${formatCurrency(savingsByTariff['GAS-RL'], 0)} €</span></td>
                            </tr>
                        </table>
                    </div>
                </div>
            `;

            const orderModel = (a, b) => {
                const order = { '2.0TD': 1, '3.0TD': 2, '6.1TD': 3, 'GAS-RL': 4, 'OTHER': 5 };
                const aModel = getTariffCategory(a.tariffModel);
                const bModel = getTariffCategory(b.tariffModel);
                
                return order[aModel] - order[bModel];
            };

            const sortedCupsData = [...state.multiCupsData].sort(orderModel); 

            let summaryCupsTableHtml = `<table style="width:100%; border-collapse:collapse; font-size:12px; margin-bottom:20px; border: 1px solid #ddd;">
                <thead>
                    <tr style="background:${cPrimary}; color:white;">
                        <th style="padding: 8px; text-align: left;">MODELO</th>
                        <th style="padding: 8px; text-align: left;">CUPS</th>
                        <th style="padding: 8px; text-align: left;">COMERCIALIZADORA / TARIFA</th> 
                        <th style="padding: 8px; text-align: right;">AHORRO ANUAL</th>
                    </tr>
                </thead>
                <tbody>`;
            
            sortedCupsData.forEach((cups, i) => {
                const model = getTariffCategory(cups.tariffModel);
                const rowBg = i % 2 === 0 ? '#f9f9f9' : '#ffffff';
                summaryCupsTableHtml += `<tr style="background:${rowBg}; border-bottom: 1px solid #eee;">
                    <td style="padding: 6px; font-weight: bold; color: #333;">${model}</td>
                    <td style="padding: 6px; font-family: monospace;">${cups.cups}</td>
                    <td style="padding: 6px; font-weight: medium; color: #555;">${cups.plan.retailer} / ${cups.plan.name}</td> 
                    <td style="padding: 6px; text-align: right; font-weight: bold; color: ${cSavingsHighlight};">${formatCurrency(cups.savings, 0)} €</td>
                </tr>`;
            });

            summaryCupsTableHtml += `<tr style="background:${cPrimary}; color:white; font-weight:bold; border-top: 2px solid white;">
                <td colspan="3" style="padding: 8px; text-align: right;">TOTAL AHORRO CONSOLIDADO</td> 
                <td style="padding: 8px; text-align: right; font-size: 14px;">${formatCurrency(totalSavings, 0)} €</td>
            </tr></tbody></table>`;


            const detailsHtml = sortedCupsData.map(cups => {
                const plan = cups.plan;
                
                const simData = getDetailedSimulacroData(plan, cups.inputs); 
                const simTotalBase = simData.power.reduce((a,b)=>a+b.cost,0) + simData.energy.reduce((a,b)=>b.cost,0);
                const isGas = plan.model.toUpperCase().includes('RL');

                const periods = getTariffPeriods(plan.tariffModel);
                const pPeriodsCount = periods.p;
                const ePeriodsCount = periods.e; 

                const getPrices = (t) => {
                    const pp = [], pe = [];
                    if (isGas) {
                        pp.push( (t.plan.tariffDetails.pow_an[0]*(1-t.plan.tariffDetails.pow_discount))/365 );
                        pe.push( t.plan.tariffDetails.en[0]*(1-t.plan.tariffDetails.en_discount) );
                    } else {
                        for(let i=0; i<pPeriodsCount; i++) pp.push( (t.plan.tariffDetails.pow_an[i]*(1-t.plan.tariffDetails.pow_discount))/365 );
                        for(let i=0; i<ePeriodsCount; i++) pe.push( t.plan.tariffDetails.en[i]*(1-t.plan.tariffDetails.en_discount) );
                    }
                    return { pp, pe };
                };
                const prices = getPrices(cups);

                const ieLabel = isGas ? 'Impuesto HC' : 'Impuesto Eléctrico (5%)';
                const ieCost = isGas ? plan.taxes.ie : plan.taxes.base_imponible - simTotalBase; // Ajuste para el Impuesto HC/IE
                
                let pricesHtml = `<table style="width:100%; border-collapse: collapse; font-size: 10px; margin-top: 5px;">
                    <tr style="background:#f3f4f6; font-weight:bold"><td style="padding:4px">CONCEPTO</td><td style="padding:4px; text-align:right">PRECIO (€)</td></tr>`;
                
                if (isGas) {
                    pricesHtml += `<tr><td style="padding:3px; color:${cPrimary}">T. Fijo Diario (€/día)</td><td style="padding:3px; text-align:right">${formatCurrency(prices.pp[0], 8)}</td></tr>`;
                    pricesHtml += `<tr><td style="padding:3px; color:${cPrimary}">T. Energía (€/kWh)</td><td style="padding:3px; text-align:right">${formatCurrency(prices.pe[0], 8)}</td></tr>`;
                    pricesHtml += `<tr><td style="padding:3px; color:${cPrimary}">Impuesto HC (€/kWh)</td><td style="padding:3px; text-align:right">${formatCurrency(IMPUESTO_HC_RATE, 8)}</td></tr>`;
                } else {
                    for (let i = 0; i < pPeriodsCount; i++) {
                        pricesHtml += `<tr><td style="padding:3px; color:${cPrimary}">Potencia P${i+1} (€/kW/día)</td><td style="padding:3px; text-align:right">${formatCurrency(prices.pp[i], 8)}</td></tr>`;
                    }
                    for (let i = 0; i < ePeriodsCount; i++) {
                        pricesHtml += `<tr><td style="padding:3px; color:${cPrimary}">Energía E${i+1} (€/kWh)</td><td style="padding:3px; text-align:right">${formatCurrency(prices.pe[i], 8)}</td></tr>`;
                    }
                }
                pricesHtml += `</table>`;
                
                const simulacroHtml = `
                    <table style="width:100%; border-collapse: collapse; font-size: 10px; margin-top: 10px;">
                        <tr style="background:#7c2d12; color:white; font-weight: bold;"><td colspan="3" style="padding: 4px;">TÉRMINO FIJO (Potencia)</td></tr>
                        ${simData.power.map(r => `
                            <tr style="border-bottom: 1px dashed #eee; background: #fafafa;">
                                <td style="padding: 2px 4px; width: 10%;">${r.name}</td>
                                <td style="padding: 2px 4px; font-family: monospace; width: 60%;">${r.formula}</td>
                                <td style="text-align: right; padding: 2px 4px; width: 30%;">${formatCurrency(r.cost, 4)} €</td>
                            </tr>
                        `).join('')}
                        
                        <tr style="background:#7c2d12; color:white; font-weight: bold;"><td colspan="3" style="padding: 4px;">TÉRMINO ENERGÍA (Consumo)</td></tr>
                        ${simData.energy.map(r => `
                            <tr style="border-bottom: 1px dashed #eee; background: #fafafa;">
                                <td style="padding: 2px 4px;">${r.name}</td>
                                <td style="padding: 2px 4px; font-family: monospace;">${r.formula}</td>
                                <td style="text-align: right; padding: 2px 4px;">${formatCurrency(r.cost, 4)} €</td>
                            </tr>
                        `).join('')}
                        
                        <!-- IMPUESTOS ESPECIALES (IE o Impuesto HC) -->
                        <tr>
                            <td colspan="2" style="padding: 4px 8px; text-align: right;">+ ${ieLabel}</td>
                            <td style="text-align: right; padding: 4px 8px;">${formatCurrency(ieCost, 4)} €</td>
                        </tr>

                        <tr style="font-weight: bold; background: #e2e8f0;"><td colspan="2" style="padding: 4px 8px; text-align: right; color: ${cPrimary};">BASE IMPONIBLE (P+E + ${isGas ? 'Impuesto HC' : 'Impuesto Eléctrico'})</td><td style="text-align: right; padding: 4px 8px; color: ${cPrimary};">${formatCurrency(plan.taxes.base_imponible, 4)} €</td></tr>
                        
                        <!-- UNIFICADO: Total Mes (Fondo cAccent) -->
                        <tr style="background:${cAccent}; color: white; font-weight: bold; font-size: 11px;">
                            <td colspan="2" style="padding: 6px 8px; text-align: right;">TOTAL MES OFERTA</td>
                            <td style="text-align: right; padding: 6px 8px;">${formatCurrency(cups.periodCost, 2)} €</td>
                        </tr>
                    </table>
                `;

                return `
                    <div style="border: 1px solid #fdba74; border-radius: 8px; padding: 15px; margin-bottom: 20px; background: #fff;">
                        <h4 style="font-size:14px; font-weight:bold; color:${cAccent}; border-bottom:1px dashed #f97316; padding-bottom:5px; margin-bottom:10px;">
                            CUPS ${cups.cupsIndex}: ${cups.cups} (${cups.tariffModel}) - ${cups.plan.retailer} / ${cups.plan.name} / ZONA: ${cups.plan.zone} 
                        </h4>
                        
                        <table border="0" cellpadding="0" cellspacing="0" style="width:100%;">
                            <tr>
                                <td style="width: 35%; vertical-align:top; padding-right:10px;">
                                    <div style="font-weight:bold; color:${cPrimary}; margin-bottom: 5px; font-size: 12px;">Tarifa / Precios Ganadores</div>
                                    ${pricesHtml}
                                </td>
                                <td style="width: 65%; vertical-align:top; border-left: 1px dashed #f5f5f5; padding-left: 20px;">
                                    <div style="font-weight:bold; color:${cPrimary}; margin-bottom: 5px; font-size: 12px;">Simulación Detallada (Cálculos)</div>
                                    ${simulacroHtml}
                                </td>
                            </tr>
                        </table>
                    </div>
                `;
            }).join('');

            const offerButtonHtml = `
                <div style="margin-top:40px; margin-bottom: 20px; background:#f0f9ff; border: 1px solid #bae6fd; padding: 15px; border-radius: 8px; text-align: center;">
                    
                    <p style="font-size: 10px; color: #666; margin-bottom: 10px;">
                        *Al hacer clic, se abrirá automáticamente su gestor de correo para enviar la solicitud de las ${state.multiCupsData.length} instalaciones.
                    </p>
                    
                    <div style="font-size: 14px; color: ${cPrimary}; font-weight: bold; margin-bottom: 5px;">
                        AHORRO TOTAL CONSOLIDADO:
                    </div>
                    <div style="font-weight: 900; font-size: 40px; color: ${cAccent}; margin-bottom: 15px; line-height: 1;">
                        ${formatCurrency(totalSavings, 0)} €
                    </div>

                    <div style="font-weight: 800; font-size: 18px; color: ${cAccent}; margin-bottom: 10px; text-transform: uppercase;">
                        ¡CONSIGUE TU AHORRO ANUAL!
                    </div>

                    <a href="${mailtoLink}" style="display: inline-block; max-width: 400px; margin: 0 auto; text-align: center; background: ${cOfferButton}; color: white; padding: 12px 30px; border-radius: 8px; text-decoration: none; font-weight: bold; font-size: 14px; border: 1px solid ${cOfferButton};">
                        ACEPTAR OFERTA CONSOLIDADA (INICIAR CONTRATACIÓN)
                    </a>
                    
                    <p style="margin-top: 15px; font-size: 11px; color: #666;">
                        Para formalizar la contratación, contacte con: <a href="mailto:${emailTarget}" style="color: ${cPrimary}; text-decoration: underline;">${emailTarget}</a>
                    </p>
                </div>
            `;

            return `
                <div class="fixed inset-0 bg-black/80 flex justify-center items-center z-50 p-4">
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-5xl max-h-[90vh] overflow-y-auto flex flex-col">
                        <div class="flex justify-between p-4 border-b bg-slate-50 sticky top-0 z-20">
                            <h2 class="font-bold text-slate-700">Informe Consolidado Multi-CUPS V4.55</h2>
                            <div class="flex gap-2">
                                <button onclick="copyVisualReport()" class="bg-orange-600 text-white px-3 py-1 rounded font-bold text-sm">COPIAR IMAGEN</button>
                                <button onclick="returnToCupsEntry()" class="text-slate-500">✕</button>
                            </div>
                        </div>
                        <div class="p-8 bg-slate-100 overflow-auto">
                            <div id="visualReportContent" style="font-family:Arial,sans-serif;max-width:900px;margin:0 auto;background:#fff;box-shadow:0 4px 15px rgba(0,0,0,0.1)">
                                
                                <div style="background:${cBgLight};padding:30px;border-bottom:4px solid ${cAccent};">
                                    <table border="0" cellpadding="0" cellspacing="0" style="width:100%;">
                                        <tr>
                                            <td style="width:50%;">
                                                <h1 style="color:${cAccent};font-size:26px;margin:0;font-weight:800">${state.config.brand.toUpperCase()}</h1>
                                                <p style="color:#666;margin:5px 0 0;font-size:13px">ASESORÍA ENERGÉTICA MULTICUPS</p>
                                            </td>
                                            <td style="width:50%; text-align:right; vertical-align:top;">
                                                <div style="font-size:22px;font-weight:900;color:${cTextDark}">INFORME CONSOLIDADO</div>
                                                <div style="color:${cPrimary};font-size:11px;text-transform:uppercase">Comparativa Profesional</div>
                                            </td>
                                        </tr>
                                    </table>
                                </div>

                                <div style="padding:15px 30px;border-bottom:1px solid #eee;background:#fcfcfc;font-size:12px;color:#555">
                                    <table border="0" cellpadding="0" cellspacing="0" style="width:100%;">
                                        <tr>
                                            <td>
                                                <strong>CLIENTE:</strong> ${state.multiCupsData[0]?.clientName || 'Cliente Consolidado'} | 
                                                <strong>CÓDIGO COMERCIAL:</strong> ${state.multiCupsData[0]?.plan?.tariffDetails?.commercialCode || state.inputs.commercialCode || 'N/A'}
                                            </td>
                                            <td style="text-align:right;">
                                                <strong>TOTAL CUPS ANALIZADOS:</strong> ${state.multiCupsData.length}
                                            </td>
                                        </tr>
                                    </table>
                                </div>

                                <div style="padding:30px">
                                    ${summaryHtml}

                                    <h3 style="color:${cPrimary};border-bottom:2px solid ${cAccent};padding-bottom:5px;margin-bottom:15px;font-size:15px;font-weight:bold;text-transform:uppercase">Resumen de Ahorro por Suministro Individual</h3>
                                    ${summaryCupsTableHtml}
                                    
                                    <h3 style="color:${cPrimary};border-bottom:2px solid ${cAccent};padding-bottom:5px;margin-bottom:20px;margin-top:30px;font-size:15px;font-weight:bold;text-transform:uppercase">Detalle Individual por Suministro (CUPS)</h3>
                                    ${detailsHtml}

                                    ${offerButtonHtml}

                                    <div style="margin-top:40px;border-top:1px solid #eee;padding-top:15px;display:flex;align-items:center;gap:15px">
                                        <div style="width:36px;height:36px;background:${cPrimary};color:white;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold">F</div>
                                        <div><div style="font-weight:bold;color:${cTextDark};font-size:13px">Fernando Araujo</div><div style="font-size:11px;color:#666">Consultor Energético | Tel: 615 43 94 28</div></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="flex justify-center p-4 border-t bg-slate-50 sticky bottom-0 z-20 gap-4">
                            <button onclick="returnToCupsEntry()" class="bg-blue-600 text-white px-5 py-2 rounded font-bold text-sm shadow-lg hover:bg-blue-700 flex items-center gap-2">
                                ${renderIcon('plus-circle', 'w-4 h-4')} AÑADIR MÁS CUPS
                            </button>
                            <button onclick="copyVisualReport()" class="bg-orange-600 text-white px-5 py-2 rounded font-bold text-sm shadow-lg hover:bg-orange-700">
                                COPIAR INFORME CONSOLIDADO
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // --- GLOBAL QR HANDLERS (Moved from renderQRScannerModal's embedded script) ---
        let QR_CANVAS, QR_CTX, QR_PASTE_ZONE, QR_PREVIEW, QR_RAW, QR_PARSED;

        const FRIENDLY_NAMES_QR = {
            'iniF': "Fecha Inicio Facturado",
            'finF': "Fecha Fin Facturado",
            'fFact': "Fecha Factura",
            'cp': "Código Postal",
            'cups': "CUPS",
            'cfP1': "Consumo Punta (E1) [kWh]",
            'cfP2': "Consumo Llano (E2) [kWh]",
            'cfP3': "Consumo Valle (E3) [kWh]",
            'pP1': "Potencia Punta (P1) [kW]",
            'pP2': "Potencia Valle (P2) [kW]",
            'imp': "Importe Total Facturado [€]",
            'finContrato': "Permanencia (Fin Contrato)",
        };

        function kv(k, v) {
            return `<div class="qr-kv"><span>${k}</span><span class="font-bold text-slate-800">${v}</span></div>`;
        }

        function parseQR(text) {
            const params = {};
            text.split("&").forEach(pair => {
                const [key, value] = pair.split("=");
                if(key && value) {
                    // Reemplaza comas por puntos para números decimales y decodifica
                    params[key] = decodeURIComponent(value.replace(/,/g, '.').trim() || "");
                }
            });
            return params;
        }

        function renderQRData(d) {
            // Calcular consumo total para mostrar
            const totalConsumption = (parseFloat(d.cfP1) || 0) + (parseFloat(d.cfP2) || 0) + (parseFloat(d.cfP3) || 0);

            let html = `<p class="font-bold text-orange-600 mb-2">CUPS: ${d.cups || 'No encontrado'}</p>`;
            
            const keys = ['iniF', 'finF', 'fFact', 'cp', 'imp', 'pP1', 'pP2', 'cfP1', 'cfP2', 'cfP3'];

            keys.forEach(key => {
                let value = d[key] || "-";
                const keyName = FRIENDLY_NAMES_QR[key] || key;
                
                // Añadir unidades para la visualización en el modal
                if (key.startsWith('pP')) value += ' kW';
                else if (key.startsWith('cfP')) value += ' kWh';
                else if (key === 'imp') value += ' €';

                html += kv(keyName, value);
            });

            // Añadir el Consumo Total Facturado (calculado)
             html += `<div class="qr-kv bg-orange-50 mt-2 font-bold text-orange-800">
                 <span>CONSUMO TOTAL FACTURADO</span>
                 <span>${formatCurrency(totalConsumption, 0)} kWh</span>
             </div>`;
            
            if (QR_PARSED) QR_PARSED.innerHTML = html;
        }

        function processImage(file) {
            const reader = new FileReader();
            reader.onload = ev => {
                const img = new Image();
                img.onload = () => {
                    if (QR_PREVIEW) {
                        QR_PREVIEW.src = ev.target.result;
                        QR_PREVIEW.style.display = "block";
                    }

                    if (!QR_CANVAS || !QR_CTX) return;

                    QR_CANVAS.width = img.width;
                    QR_CANVAS.height = img.height;
                    QR_CTX.drawImage(img, 0, 0);

                    const imageData = QR_CTX.getImageData(0, 0, QR_CANVAS.width, QR_CANVAS.height);
                    const code = jsQR(imageData.data, QR_CANVAS.width, QR_CANVAS.height);

                    if (!code) {
                        if (QR_RAW) QR_RAW.value = "No se pudo leer el QR. Intenta con una captura más nítida.";
                        if (QR_PARSED) QR_PARSED.innerHTML = "❌ No se pudo localizar o decodificar el Código QR.";
                        return;
                    }

                    if (QR_RAW) QR_RAW.value = code.data;
                    const data = parseQR(code.data);
                    renderQRData(data);
                    
                    // LLAMADA AL EXTERIOR: Mapeo de datos para la aplicación principal
                    if (data.cups && data.imp) {
                        window.applyQRData(data); // Llama a la función del scope principal
                    }
                };
                img.src = ev.target.result;
            };
            reader.readAsDataURL(file);
        }

        function handleQRModalPaste(e) {
            const items = e.clipboardData.items;
            let imageDetected = false;
            for (let item of items) {
                if (item.type.indexOf("image") !== -1) {
                    const file = item.getAsFile();
                    processImage(file);
                    imageDetected = true;
                    e.preventDefault();
                    break;
                }
            }
            if (!imageDetected) {
                if (QR_RAW) QR_RAW.value = "No se detectó una imagen válida en el portapapeles.";
                if (QR_PARSED) QR_PARSED.innerHTML = "No se pudo leer la imagen.";
                if (QR_PREVIEW) QR_PREVIEW.style.display = "none";
            }
        }

        function handleQRModalDragOver(e) {
            e.preventDefault();
            if (QR_PASTE_ZONE) QR_PASTE_ZONE.classList.add('focused');
        }

        function handleQRModalDragLeave(e) {
            e.preventDefault();
            if (QR_PASTE_ZONE) QR_PASTE_ZONE.classList.remove('focused');
        }

        function handleQRModalDrop(e) {
            e.preventDefault();
            if (QR_PASTE_ZONE) QR_PASTE_ZONE.classList.remove('focused');
            
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].type.startsWith("image")) {
                processImage(files[0]);
            } else {
                if (QR_PARSED) QR_PARSED.innerHTML = "El archivo soltado no es una imagen válida.";
                if (QR_RAW) QR_RAW.value = "Error: El archivo soltado no es una imagen válida.";
                if (QR_PREVIEW) QR_PREVIEW.style.display = "none";
            }
        }

        function setupQRModalListeners() {
            // Eliminar listeners previos para evitar duplicados
            if (QR_PASTE_ZONE) {
                QR_PASTE_ZONE.removeEventListener("paste", handleQRModalPaste);
                QR_PASTE_ZONE.removeEventListener('dragover', handleQRModalDragOver);
                QR_PASTE_ZONE.removeEventListener('dragleave', handleQRModalDragLeave);
                QR_PASTE_ZONE.removeEventListener('drop', handleQRModalDrop);
                QR_PASTE_ZONE.removeEventListener("focus", () => QR_PASTE_ZONE.classList.add("focused"));
                QR_PASTE_ZONE.removeEventListener("blur", () => QR_PASTE_ZONE.classList.remove("focused"));
            }

            QR_PASTE_ZONE = document.getElementById("pasteZone");
            QR_PREVIEW = document.getElementById("qr-preview");
            QR_RAW = document.getElementById("raw-qr-data");
            QR_PARSED = document.getElementById("parsed-qr-data");
            QR_CANVAS = document.getElementById("qr-canvas");
            QR_CTX = QR_CANVAS ? QR_CANVAS.getContext("2d") : null;
            
            if (QR_PASTE_ZONE) {
                // Manejo de enfoque y desenfoque
                QR_PASTE_ZONE.addEventListener("focus", () => QR_PASTE_ZONE.classList.add("focused"));
                QR_PASTE_ZONE.addEventListener("blur", () => QR_PASTE_ZONE.classList.remove("focused"));

                // Manejo del evento de pegado
                QR_PASTE_ZONE.addEventListener("paste", handleQRModalPaste);
                
                // Manejo de Drag & Drop
                QR_PASTE_ZONE.addEventListener('dragover', handleQRModalDragOver);
                QR_PASTE_ZONE.addEventListener('dragleave', handleQRModalDragLeave);
                QR_PASTE_ZONE.addEventListener('drop', handleQRModalDrop);
            }
        }
        // --- FIN GLOBAL QR HANDLERS ---


        // --- RENDERIZADO DE MODAL QR (NUEVO) ---
        function renderQRScannerModal() {
            if (!state.showQRScannerModal) return '';

            // Ya no se incluye el script aquí, solo el HTML del modal
            return `
                <div id="qrScannerModal" class="fixed inset-0 bg-black/80 flex justify-center items-center z-50 p-4">
                    <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto flex flex-col">
                        <div class="flex justify-between p-4 border-b bg-slate-50 sticky top-0 z-20">
                            <h2 class="font-bold text-slate-700 flex items-center gap-2">${renderIcon('scan-line','w-5 h-5 text-orange-600')} Escáner QR CNMC (2.0TD)</h2>
                            <button onclick="setState({showQRScannerModal:false})" class="text-slate-500">✕</button>
                        </div>
                        <div class="p-6 bg-slate-100 overflow-auto">
                            <div class="bg-white p-6 rounded-xl shadow-lg">
                                <h3 class="text-lg font-bold text-slate-700 mb-2">Paso 1: Pegar Captura de Pantalla</h3>
                                <p class="text-sm text-slate-600 mb-4">
                                    Haz clic en el cuadro, toma una captura de pantalla del código QR (Ctrl+Shift+S o Cmd+Shift+4) y pégala con <strong>Ctrl+V</strong>.
                                </p>

                                <div id="pasteZone" class="qr-paste-zone" tabindex="0">
                                    Haz clic aquí y pulsa <strong>Ctrl+V</strong> para pegar la captura del QR.
                                </div>

                                <img id="qr-preview" alt="QR Preview">

                                <h3 class="text-lg font-bold text-slate-700 mt-6 mb-2">Paso 2: Resultado del Escaneo</h3>
                                <textarea id="raw-qr-data" placeholder="Aquí aparecerá la cadena de texto cruda del código QR (Ej: iniF=...&cfP1=...)" rows="3" readonly class="w-full p-2 border rounded font-mono text-xs"></textarea>

                                <h3 class="text-lg font-bold text-slate-700 mt-6 mb-2">Paso 3: Datos de Factura Mapeados</h3>
                                <div id="parsed-qr-data" class="qr-block">Pega una captura de un QR válido para ver los datos de la factura.</div>
                                
                                <canvas id="qr-canvas" style="display:none;"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }


        function renderUI() {
            const mainGrid = document.getElementById('main-content-grid');
            const multiCupsReportSection = document.getElementById('multi-cups-report-section');
            const headerToggle = document.getElementById('multi-cups-toggle');
            
            if (multiCupsReportSection) multiCupsReportSection.innerHTML = state.isFinalReportVisible ? renderMultiCupsReport() : '';

            if (state.isFinalReportVisible) {
                if (mainGrid) mainGrid.classList.add('hidden'); 
                if (headerToggle) headerToggle.disabled = true; 
            } else {
                if (mainGrid) mainGrid.classList.remove('hidden'); 
                if (headerToggle) headerToggle.disabled = false;
                
                const editor = document.getElementById('drk-editor');
                if (editor) editor.innerHTML = renderTariffDatabaseSection();
                
                const clientInputs = document.getElementById('client-inputs-section');
                if (clientInputs) clientInputs.innerHTML = renderClientInputs();
                
                const resultsSection = document.getElementById('results-section');
                if (resultsSection) resultsSection.innerHTML = renderResults();
                
                const modalContainer = document.getElementById('modal-container');
                if (modalContainer) {
                    const qrModalHtml = state.showQRScannerModal ? renderQRScannerModal() : '';
                    const reportModalHtml = state.showReportModal ? renderReportModal() : '';
                    
                    modalContainer.innerHTML = reportModalHtml + qrModalHtml;
                    
                    // NUEVO: Llama a la función de configuración de listeners solo si el modal QR está visible
                    if (state.showQRScannerModal) {
                        setupQRModalListeners(); 
                    }
                }
            }
            
            // --- INICIO: CORRECCIÓN DE DÍAS VISIBLES EN EL INPUT DE CABECERA ---
            const daysInput = document.getElementById('days-input');
            if (daysInput && daysInput.value !== String(state.config.days)) {
                // Forzar la actualización del valor del DOM con el valor del estado
                daysInput.value = state.config.days;
            }
            // --- FIN: CORRECCIÓN DE DÍAS VISIBLES EN EL INPUT DE CABECERA ---

            if (window.lucide) window.lucide.createIcons();
            
            const brandElement = document.getElementById('main-brand');
            if (brandElement) {
                brandElement.textContent = state.config.brand === 'DRK' ? 'DRK ENERGÍA' : 'POWER CUP';
            }
        }

        function renderTariffDatabaseSection() {
            const hasData = state.uploadedTariffs.length > 0;
            const allResults = state.comparisonResults;
            const selectedRetailers = getSelectedRetailers(state.selectedRankingIds, allResults);
            
            const lastUploadDate = state.config.lastUploadDate;
            const uploadDateHtml = lastUploadDate 
                ? `(Última carga: ${lastUploadDate.toLocaleDateString('es-ES', { day: '2-digit', month: 'short', year: 'numeric' })})` 
                : '(No hay tarifas cargadas)';

            const persistenceMode = isFirebaseReady ? 
                `<span class="text-xs bg-green-100 text-green-800 px-2 py-0.5 rounded-full flex items-center gap-1">${renderIcon('cloud','w-3 h-3')} Nube (Firebase)</span>` :
                `<span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded-full flex items-center gap-1">${renderIcon('hard-drive','w-3 h-3')} Local (LocalStorage)</span>`;


            const currentTariffModel = state.config.tariff;
            
            // Filtra opciones de Segmento basadas en el modelo de tarifa actual
            const filteredSegmentOptions = [...new Set(state.uploadedTariffs
                .filter(t => getTariffCategory(t.model) === getTariffCategory(currentTariffModel))
                .map(t => t.segment)
            )].sort();

            // Filtra opciones de Zona Geográfica basadas en el modelo de tarifa actual
            const filteredZoneOptions = [...new Set(state.uploadedTariffs
                .filter(t => getTariffCategory(t.model) === getTariffCategory(currentTariffModel))
                .map(t => t.zone)
            )].sort();

            const winningPlan = allResults.find(p => p.id === state.config.winningTariffId);
            const winningSavings = winningPlan ? winningPlan.savings : Infinity;

            const isDrkBrand = state.config.brand === 'DRK';
            
            const winningRetailerOptions = [...new Set(allResults.map(r => r.retailer))].sort();


            const filteredWinningResults = allResults.filter(p => {
                if (state.config.winningRetailerFilter && p.retailer !== state.config.winningRetailerFilter) return false;
                if (getTariffCategory(p.model) !== getTariffCategory(currentTariffModel)) return false;
                return true;
            });
            
            const rankingRetailerOptions = [...new Set(allResults.map(r => r.retailer))].sort();

            const filteredRankingResults = allResults.filter(p => {
                if (state.config.rankingRetailerFilter && p.retailer !== state.config.rankingRetailerFilter) return false;
                if (getTariffCategory(p.model) !== getTariffCategory(currentTariffModel)) return false;
                
                if (winningPlan && p.savings > winningSavings) {
                    return false;
                }
                
                return true;
            });
            
            const isCalculateDisabled = !hasData || !state.config.segmentFilter || !state.config.zoneFilter; // NUEVO: Deshabilitar sin zona
            const calculateButtonText = hasData 
                ? (state.config.segmentFilter && state.config.zoneFilter ? 'RE-CALCULAR Y FILTRAR' : 'SELECCIONAR FILTROS') 
                : 'CARGAR EXCEL DE TARIFAS';

            const isMultiCups = state.config.isMultiCupsMode;
            
            return `<div class="bg-white p-4 rounded-xl shadow-lg border-2 border-orange-500/20 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-orange-700 flex gap-2">${renderIcon('database','w-5 h-5')} Base de Datos y Filtros</h3>
                    <div class="flex flex-col items-end gap-1">
                        ${persistenceMode}
                        <span class="text-xs bg-slate-100 px-2 py-1 rounded">${state.uploadedTariffs.length} Tarifas ${uploadDateHtml}</span>
                    </div>
                </div>
                
                <!-- SECCIÓN DE CARGA Y FILTROS -->
                ${!hasData ? `<div class="relative group"><input type="file" accept=".xlsx,.csv" onchange="handleExcelUpload(event)" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer"><button class="w-full bg-orange-600 text-white py-2 rounded font-bold flex justify-center gap-2">${state.isScanning?renderIcon('loader','animate-spin'):renderIcon('upload','')} ${calculateButtonText}</button></div>` : 
                `
                <!-- BOTONES DE CARGA Y BORRADO -->
                <div class="mb-4 pt-4 border-t border-slate-200 grid grid-cols-2 gap-4"> 
                    <div class="relative group">
                        <input type="file" accept=".xlsx,.csv" onchange="handleExcelUpload(event)" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                        <button class="w-full bg-slate-200 text-slate-800 py-2 rounded font-bold flex justify-center gap-2 hover:bg-slate-300">
                            ${renderIcon('upload','w-5 h-5')} SUBIR Y REEMPLAZAR TARIFAS (Excel)
                        </button>
                    </div>
                   <button onclick="deleteTariffsFromStorage()" class="w-full bg-red-500 text-white py-2 rounded font-bold flex justify-center gap-2 hover:bg-red-600 ${!hasData ? 'opacity-50 cursor-not-allowed' : ''}" ${!hasData ? 'disabled' : ''}>
                        ${renderIcon('trash-2','w-5 h-5')} BORRAR TARIFAS GUARDADAS
                    </button>
                </div>
                
                <!-- SECCIÓN DE FILTROS Y CALCULAR -->
                <div class="grid md:grid-cols-4 gap-4 items-end">
                    
                    <div>
                        <label class="text-xs font-bold text-slate-500">Segmento (${currentTariffModel})</label>
                        <select onchange="handleSegmentFilterChange(event)" class="w-full p-2 border rounded font-bold text-orange-800">
                            <option value="" disabled ${!state.config.segmentFilter ? 'selected' : ''}>Seleccionar...</option>
                            ${filteredSegmentOptions.map(s=>`<option value="${s}" ${state.config.segmentFilter === s ? 'selected' : ''}>${s}</option>`).join('')}
                        </select>
                    </div>

                    <div>
                        <label class="text-xs font-bold text-slate-500">Zona Geográfica</label>
                        <select onchange="handleZoneFilterChange(event)" class="w-full p-2 border rounded font-bold text-orange-800">
                            <option value="" disabled ${!state.config.zoneFilter ? 'selected' : ''}>Seleccionar...</option>
                            ${filteredZoneOptions.map(z=>`<option value="${z}" ${state.config.zoneFilter === z ? 'selected' : ''}>${z}</option>`).join('')}
                        </select>
                    </div>
                    
                    ${isMultiCups ? 
                        `
                            <button onclick="calculate()" class="w-full bg-orange-600 text-white py-2 rounded font-bold shadow hover:bg-orange-700 col-span-2 ${isCalculateDisabled ? 'opacity-50 cursor-not-allowed bg-orange-400 hover:bg-orange-400' : ''}" ${isCalculateDisabled ? 'disabled' : ''}>
                                ${calculateButtonText}
                            </button>
                        `
                        :
                        `
                            <div>
                                <label class="text-xs font-bold text-slate-500">Cía (Opcional)</label>
                                <select onchange="handleRetailerFilterChange(event)" class="w-full p-2 border rounded">
                                    <option value="">Todas</option>
                                    ${state.retailerFilterOptions.map(r=>`<option value="${r}" ${state.config.retailerFilter === r ? 'selected' : ''}>${r}</option>`).join('')}
                                </select>
                            </div>
                            <button onclick="calculate()" class="w-full bg-orange-600 text-white py-2 rounded font-bold shadow hover:bg-orange-700 ${isCalculateDisabled ? 'opacity-50 cursor-not-allowed bg-orange-400 hover:bg-orange-400' : ''}" ${isCalculateDisabled ? 'disabled' : ''}>
                                ${calculateButtonText}
                            </button>
                        `
                    }
                </div>
                `}
                
                <!-- SECCIÓN DE SELECCIÓN DE GANADOR Y RANKING -->
                ${state.comparisonResults.length > 0 ? `
                <div class="mt-6 pt-4 border-t border-slate-200 space-y-4">
                    
                    <h4 class="font-bold text-slate-700 flex gap-2">${renderIcon('award','w-4 h-4 text-orange-600')} 1. Seleccionar Tarifa Ganadora (Ganadora: ${winningPlan ? winningPlan.retailer : 'N/A'})</h4>
                    
                    <div class="flex items-center gap-2">
                        <label class="text-xs font-bold text-slate-500">Filtrar Cía Ganadora:</label>
                        <select onchange="handleWinningRetailerFilterChange(event)" class="p-1 border rounded text-sm flex-grow" value="${state.config.winningRetailerFilter}">
                            <option value="">Mostrar Todas</option>
                            ${winningRetailerOptions.map(r=>`<option value="${r}" ${state.config.winningRetailerFilter === r ? 'selected' : ''}>${r}</option>`).join('')}
                        </select>
                    </div>

                    <select onchange="handleWinningSelection(event)" class="w-full p-2 border border-orange-400 rounded font-bold text-slate-800 shadow-md bg-orange-50" value="${state.config.winningTariffId || ''}">
                        <option value="" disabled ${!state.config.winningTariffId ? 'selected' : ''}>-- ELEGIR TARIFAS GANADORA --</option>
                        ${filteredWinningResults.map(p => {
                            return `<option value="${p.id}" ${state.config.winningTariffId === p.id ? 'selected' : ''}>${p.retailer} | ${p.name} (Ahorro: ${formatCurrency(p.savings,0)}€) (${p.model} - ${p.zone})</option>`;
                        }).join('')}
                    </select>

                    ${isDrkBrand || state.config.isMultiCupsMode || currentTariffModel === 'GAS-RL' ? 
                        `<div class="pt-2 text-sm text-slate-500 font-medium">Modo ${isDrkBrand ? 'DRK ENERGÍA' : (state.config.isMultiCupsMode ? 'MULTI-CUPS' : 'GAS-RL')}: Oferta única forzada.</div>` :
                        `<div class="flex items-center justify-between pt-2">
                            <h4 class="font-bold text-slate-700 flex gap-2">${renderIcon('list-checks','w-4 h-4 text-slate-600')} 2. Ranking de Opciones (Max 5 / 1 por Cía)</h4>
                            <button onclick="resetRankingSelection()" class="text-xs text-red-500 hover:text-red-700 font-bold p-1 rounded-md flex items-center gap-1 border border-red-300 bg-red-50">
                                ${renderIcon('rotate-ccw', 'w-3 h-3')} Resetear Ranking
                            </button>
                        </div>
                        
                        <div class="flex items-center gap-2">
                            <label class="text-xs font-bold text-slate-500">Filtrar Cía:</label>
                            <select onchange="handleRankingRetailerFilterChange(event)" class="p-1 border rounded text-sm flex-grow" value="${state.config.rankingRetailerFilter}">
                                <option value="">Mostrar Todas</option>
                                ${rankingRetailerOptions.map(r=>`<option value="${r}" ${state.config.rankingRetailerFilter === r ? 'selected' : ''}>${r}</option>`).join('')}
                            </select>
                        </div>

                        <div class="max-h-32 overflow-y-auto custom-scrollbar border rounded p-2 bg-slate-50 grid grid-cols-1 md:grid-cols-2 gap-2">
                            ${filteredRankingResults.map(p => {
                                const isSelected = state.selectedRankingIds.includes(p.id);
                                const isWinningRetailer = winningPlan && winningPlan.retailer === p.retailer && !isSelected;
                                const isRetailerSelected = selectedRetailers.has(p.retailer) && !isSelected;
                                const isMaxedOut = state.selectedRankingIds.length >= 5 && !isSelected;
                                const isDisabled = isRetailerSelected || isMaxedOut || isWinningRetailer;
                                const displayAsWinning = winningPlan && p.id === winningPlan.id;

                                return `<label class="flex items-center gap-2 text-xs p-1 hover:bg-white rounded ${isDisabled ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer'}">
                                    <input type="checkbox" onchange="handleRankingSelection('${p.id}',this.checked)" 
                                        ${isSelected?'checked':''} 
                                        ${isDisabled?'disabled':''}
                                        class="rounded text-orange-600"> 
                                    <span class="truncate font-medium text-slate-70um ${displayAsWinning ? 'font-bold text-orange-800' : ''}">${p.retailer} - ${p.name} (Ahorro: ${formatCurrency(p.savings,0)}€) ${displayAsWinning ? '(GANADORA)' : ''}</span>
                                </label>`;
                            }).join('')}
                        </div>`}
                </div>` : ''}
            </div>`;
        }

        function renderClientInputs() {
            const currentTariffModel = state.config.tariff;
            const isGas = currentTariffModel === 'GAS-RL';
            const daysIsDisabled = currentTariffModel === '2.0TD' || isGas;

            // Para GAS: solo necesitamos el Consumo Total (en p1_kwh) y el Total Factura
            const rows = [1,2,3,4,5,6].map(i => {
                const is20 = currentTariffModel === '2.0TD';
                
                // Disabling/Hiding logic for Electricity
                const pDis = is20 && i > 2; 
                const eDis = is20 && i > 3; 
                
                // Visibility logic for Gas
                const hideRow = isGas && i > 1; // Solo mostramos la fila P1 para el consumo total de Gas
                if (hideRow) return '';
                
                // Custom labels for Gas mode
                const pLabel = isGas ? 'Término Fijo Anual (€/año)' : 'Potencia (kW)';
                const eLabel = isGas ? 'Consumo Total (kWh/Sm3)' : 'Energía (kWh)';


                return `<div class="grid grid-cols-12 gap-2 text-sm mb-1 items-center">
                    <div class="col-span-1 font-bold text-slate-500 text-center bg-slate-100 rounded">${isGas ? 'Consumo' : `P${i}`}</div>
                    
                    <!-- CAMPO POTENCIA / TÉRMINO FIJO ANUAL (Solo fila 1 en Gas) -->
                    <div class="col-span-5">
                       <input type="number" step="0.01" 
                          oninput="handleInputRaw('p${i}_kw', this.value)" 
                          onblur="handleInputBlur('p${i}_kw', this.value)" 
                          class="w-full p-1 border rounded outline-none focus:border-orange-500 ${isGas && i===1 ? 'bg-orange-50' : (pDis?'bg-slate-50':'')}" 
                          placeholder="${isGas && i===1 ? 'T.Fijo Anual (R)' : 'kW'}" 
                          value="${state.inputs[`p${i}_kw`]||''}" 
                          ${isGas && i!==1 ? 'disabled' : (pDis?'disabled':'')}
                          title="${pLabel}">
                    </div>
                    
                    <!-- CAMPO ENERGÍA / CONSUMO TOTAL (Solo fila 1 en Gas) -->
                    <div class="col-span-6">
                       <input type="number" step="1" 
                          oninput="handleInputRaw('p${i}_kwh', this.value)" 
                          onblur="handleInputBlur('p${i}_kwh', this.value)" 
                          class="w-full p-1 border rounded outline-none focus:border-orange-500 ${isGas && i===1 ? 'bg-orange-50' : (eDis?'bg-slate-50':'')}" 
                          placeholder="${isGas && i===1 ? 'Consumo (K)' : 'kWh'}" 
                          value="${state.inputs[`p${i}_kwh`]||''}" 
                          ${isGas && i!==1 ? 'disabled' : (eDis?'disabled':'')}
                          title="${eLabel}">
                    </div>
                </div>`;
            }).join('');
            
            const codeInput = `<div class="mb-4">
                <label class="text-xs font-bold text-slate-500">CÓDIGO COMERCIAL</label>
                <input type="text" oninput="handleInputRaw('commercialCode', this.value)" onblur="handleInputBlur('commercialCode', this.value)" class="w-full p-2 text-lg font-bold border rounded focus:border-orange-500" placeholder="Ej: F.ARAUJO.001" value="${state.inputs.commercialCode}">
            </div>`;

            const clientDataCard = `<div class="bg-white p-4 rounded-xl shadow mb-6">
                <h3 class="font-bold text-slate-700 mb-3 flex gap-2">Datos de Cliente ${state.config.isMultiCupsMode ? `(CUPS #${state.currentCupsIndex})` : ''}</h3>
                <input type="text" placeholder="Nombre Cliente" class="w-full border-b p-2 outline-none mb-2 font-bold text-slate-700" oninput="handleInputRaw('clientName',this.value,'inputs')" onblur="handleInputBlur('clientName',this.value,'inputs')" value="${state.inputs.clientName}">
                <input type="text" placeholder="CUPS" class="w-full border-b p-2 outline-none text-xs uppercase" oninput="handleInputRaw('cups',this.value,'inputs')" onblur="handleInputBlur('cups',this.value,'inputs')" value="${state.inputs.cups}">
            </div>`;
            
            // NUEVO: Botón de escaneo QR para 2.0TD
            const qrScannerButton = (currentTariffModel === '2.0TD') ? 
                `<button onclick="openQRScanner()" class="w-full bg-slate-200 text-slate-800 py-2 rounded font-bold flex justify-center gap-2 hover:bg-slate-300 items-center">
                    ${renderIcon('qr-code','w-5 h-5')} ESCANEAR QR FACTURA (2.0TD)
                </button>` : '';


            return `
            ${clientDataCard}
            <div class="bg-white p-4 rounded-xl shadow mb-6">
                <h3 class="font-bold text-slate-700 mb-3 flex gap-2">${renderIcon(isGas ? 'flame' : 'zap','w-4 h-4 text-orange-500')} Datos Factura (${currentTariffModel})</h3>
            
                <div class="mb-4">${qrScannerButton}</div> 

                <div class="mb-4">
                   <label class="text-xs font-bold text-slate-500">Días Facturados (Bloqueado: ${daysIsDisabled ? 'Sí' : 'No'})</label>
                   <input type="number" 
                          id="days-input-local"
                          value="${state.config.days}"
                          onblur="handleConfigChange('days', this.value)"
                          class="w-full p-2 text-lg font-bold border rounded focus:border-orange-500 ${daysIsDisabled ? 'bg-slate-100' : ''}" 
                          placeholder="30"
                          ${daysIsDisabled ? 'disabled' : ''}>
                </div>
                
                <div class="mb-4"><label class="text-xs font-bold text-slate-500">Total Factura (€)</label><input type="number" step="0.01" oninput="handleInputRaw('clientTotalInvoice', this.value)" onblur="handleInputBlur('clientTotalInvoice', this.value)" class="w-full p-2 text-lg font-bold border rounded focus:border-orange-500" placeholder="0.00" value="${state.inputs.clientTotalInvoice||''}"></div>
            
                ${codeInput}

                <div class="grid grid-cols-12 gap-2 text-xs font-bold text-slate-400 mb-1 text-center">
                    <div class="col-span-1"></div>
                    <div class="col-span-5">${isGas ? 'Término Fijo' : 'Potencia'}</div>
                    <div class="col-span-6">${isGas ? 'Consumo' : 'Energía'}</div>
                </div>
                ${rows}
            </div>`;
        }

        function renderResults() {
            if(!state.result || !state.config.winningTariffId) return '';
            const plan = state.result.bestPlan;
            const isReady = !!plan && !!state.result.current;
            
            if (state.config.isMultiCupsMode) {
                if (!state.currentStudyResult) return ''; 
                
                const nextCupsButton = `<button 
                    onclick="saveCupsAndProceed()" 
                    class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded shadow-lg flex justify-center gap-2"
                >
                    ${renderIcon('arrow-right', 'w-5 h-5')} SIGUIENTE CUPS (${state.multiCupsData.length + 1})
                </button>`;
                
                const finalizeButton = `<button 
                    onclick="finalizeMultiCups()" 
                    class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded shadow-lg flex justify-center gap-2"
                >
                    ${renderIcon('flag', 'w-5 h-5')} FINALIZAR Y CONSOLIDAR
                </button>`;

                return `<div class="bg-slate-900 text-white rounded-xl shadow-xl p-6 relative overflow-hidden">
                    <div class="relative z-10">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <div class="text-orange-500 font-bold text-sm tracking-wider uppercase">Resultado CUPS #${state.currentCupsIndex}</div>
                                <h2 class="text-xl font-bold">${plan.retailer} | ${plan.name}</h2>
                            </div>
                            <div class="text-right">
                                <div class="text-3xl font-bold">${formatCurrency(plan.savings,0)}€</div>
                                <div class="text-xs text-orange-400 font-bold uppercase">Ahorro Estimado</div>
                            </div>
                        </div>
                        <div class="flex gap-4 mt-4">
                            ${nextCupsButton}
                            ${finalizeButton}
                        </div>
                        
                        <p class="text-xs text-slate-400 mt-4">
                            Suministros guardados: ${state.multiCupsData.length}. Pulse "Siguiente CUPS" para guardar este estudio.
                        </p>
                    </div>
                </div>`;
            }
            
            return `<div class="bg-slate-900 text-white rounded-xl shadow-xl p-6 relative overflow-hidden">
                <div class="absolute top-0 right-0 p-4 opacity-10">${renderIcon('award','w-32 h-32')}</div>
                <div class="relative z-10">
                    <div class="flex justify-between items-start mb-4">
                        <div><div class="text-orange-500 font-bold text-sm tracking-wider uppercase">Tarifa Ganadora Seleccionada</div><h2 class="text-2xl font-bold">${plan.retailer} <span class="font-normal text-slate-400">| ${plan.name}</span></h2></div>
                        <div class="text-right"><div class="text-3xl font-bold">${formatCurrency(plan.savings,0)}€</div><div class="text-xs text-orange-400 font-bold uppercase">Ahorro Estimado</div></div>
                    </div>
                    <button 
                        onclick="setState({showReportModal:true})" 
                        class="w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 rounded shadow-lg flex justify-center gap-2 ${!isReady ? 'opacity-50 cursor-not-allowed' : ''}"
                        ${!isReady ? 'disabled' : ''}
                    >
                        ${renderIcon('file-text','w-5 h-5')} GENERAR INFORME DETALLADO
                    </button>
                </div>
            </div>`;
        }

        function showNotification(m, t) {
            const d = document.createElement('div');
            d.className = `p-4 rounded shadow-lg text-white mb-2 flex gap-2 ${t==='error'?'bg-red-600':(t==='info'?'bg-orange-600':'bg-slate-800')}`;
            d.innerHTML = `<span>${m}</span>`;
            document.getElementById('notification-container').appendChild(d);
            setTimeout(()=>d.remove(), 3000);
        }
        function copyVisualReport() {
            const contentId = state.isFinalReportVisible ? 'visualReportContent' : 'visualReportContent'; 
            const r = document.createRange(); 
            const contentElement = document.getElementById(contentId);
            
            if (contentElement) {
                r.selectNode(contentElement);
                window.getSelection().removeAllRanges(); 
                window.getSelection().addRange(r);
                document.execCommand('copy'); 
                window.getSelection().removeAllRanges();
                showNotification("Copiado al portapapeles", "success");
            } else {
                 showNotification("No hay contenido para copiar.", "error");
            }
        }

        window.onload = initializeApp;
    </script>
</head>
<body>
    <div id="multi-cups-report-section"></div>

    <div id="main-content-grid" class="min-h-screen p-4 max-w-5xl mx-auto">
        <header class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-black text-slate-800 tracking-tight">
                <span id="main-brand" class="text-orange-600"></span> 
                <span class="text-slate-400 font-light text-lg">| Comparador V4.55</span>
            </h1>
            <div class="flex gap-4 items-center">
                
                <label class="flex items-center space-x-2 text-xs font-medium text-slate-700">
                    <input type="checkbox" id="multi-cups-toggle"
                                                    onchange="handleMultiCupsModeChange(event)" 
                                                    ${state.config.isMultiCupsMode ? 'checked' : ''} 
                                                    class="rounded text-orange-600 focus:ring-orange-500">
                    <span>Multi-CUPS</span>
                </label>
                
                <select onchange="handleBrandChange(event)" class="bg-white border rounded p-1 font-bold text-sm text-slate-600 shadow-sm">
                    <option value="POWER CUP" ${state.config.brand === 'POWER CUP' ? 'selected' : ''}>POWER CUP</option>
                    <option value="DRK" ${state.config.brand === 'DRK' ? 'selected' : ''}>DRK ENERGÍA</option>
                </select>

                <select onchange="handleTariffChange(event)" class="bg-white border rounded p-1 font-bold text-sm text-slate-600 shadow-sm">
                    <option value="GAS-RL" ${state.config.tariff === 'GAS-RL' ? 'selected' : ''}>GAS RLx</option>
                    <option value="3.0TD" ${state.config.tariff === '3.0TD' ? 'selected' : ''}>3.0TD</option>
                    <option value="2.0TD" ${state.config.tariff === '2.0TD' ? 'selected' : ''}>2.0TD</option>
                    <option value="6.1TD" ${state.config.tariff === '6.1TD' ? 'selected' : ''}>6.1TD</option>
                </select>
                <!-- Días de facturación: Muestra el valor de estado. Ahora solo editable si NO es 2.0TD ni GAS-RL -->
                <input type="number" 
                    id="days-input" 
                    value="${state.config.days}" 
                    onblur="handleConfigChange('days',this.value)" 
                    class="w-12 text-center border rounded p-1 font-bold text-sm text-slate-600 shadow-sm" 
                    title="Días Factura"
                    ${state.config.tariff === '2.0TD' || state.config.tariff === 'GAS-RL' ? 'disabled' : ''}
                    >

                <label class="flex items-center space-x-2 text-xs font-medium text-slate-700 ${state.config.brand === 'DRK' || state.config.tariff === 'GAS-RL' ? 'opacity-50' : ''}">
                    <input type="checkbox" 
                                                    onchange="handleConfigChange('isSinglePresentationMode', this.checked)" 
                                                    ${state.config.isSinglePresentationMode || state.config.tariff === 'GAS-RL' ? 'checked' : ''} 
                                                    ${state.config.brand === 'DRK' || state.config.tariff === 'GAS-RL' ? 'disabled' : ''} 
                                                    class="rounded text-orange-600 focus:ring-orange-500">
                    <span>Oferta Única</span>
                </label>
            </div>
        </header>

        <div class="grid md:grid-cols-3 gap-6">
            <div class="md:col-span-1 space-y-6">
                <div id="client-inputs-section"></div>
            </div>
            
            <div class="md:col-span-2 space-y-6">
                <div id="drk-editor"></div>
                <div id="results-section"></div>
            </div>
        </div>
    </div>
    
    <div id="modal-container"></div>
    <div id="notification-container" class="fixed top-4 right-4 z-50"></div>
</body>
</html>
